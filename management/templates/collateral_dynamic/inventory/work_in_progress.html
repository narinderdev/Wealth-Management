{% load static %}
<style>
  :root{
    --bg:#f6f9fd;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#6b7280;
    --line:#e7eef7;
    --line2:#f0f5fb;
    --primary:#1e6fe0;
    --primary-2:#2c7be5;
    --success:#16a34a;
    --danger:#ef4444;
    --shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    --radius:14px;
  }
  *{box-sizing:border-box;}
  .work-in-progress .page{
    max-width:1120px;
    margin:18px auto;
    padding:0 14px 28px;
  }
   .main-head{
     font-size: 24px;
     font-weight: 800;
     color:black;
     margin-top: 0px;
     margin-bottom: 0px;
     font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
     
    }
  .work-in-progress .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    /* box-shadow:var(--shadow); */
  }
  .work-in-progress .summary-card{
    border:1px solid #E6EAF2;
    border-radius:12px;
    box-shadow:0 1px 2px rgba(16,24,40,.06);
    overflow:hidden;
    background:#fff;
    height:100%;
  }
  .work-in-progress .summary-card.ineligible-card{
    border:1px solid #e6edf7;
    border-left:0;
    border-right:0;
    border-radius:14px;
    box-shadow:none;
  }
  .work-in-progress .section{
    padding:16px 18px;
    
   
  }
  .work-in-progress .title{
       display:flex;
    align-items:center;
 color: #585858;

font-size: 24px;
font-style: normal;
font-weight: 600;
line-height: 24px; /* 100% */
letter-spacing: -0.6px;
gap: 9px;
  }
  .work-in-progress .title .icon{
    width:18px;height:18px;display:grid;place-items:center;
    color:var(--primary);
  }
  .work-in-progress .grid-2{
    margin-top:10px;
    display:grid;
    grid-template-columns:1fr 2fr;
    gap:16px;
    align-items:stretch;
  }
  .work-in-progress .metric-stack{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .work-in-progress .metric{
    border:1px solid var(--line);
    border-radius:12px;
    padding:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    min-height:86px;
    background:#fff;
  }
  .work-in-progress .metric .label{
     color: #65758B;


font-size: 14px;
font-style: normal;
font-weight: 400;
line-height: 21px; /* 132.296% */
  }
  .work-in-progress .metric .value{
 color: #344256;


font-size: 24.078px;
font-style: normal;
font-weight: 700;
line-height: 50px;
  }
  .work-in-progress .metric .delta{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:700;
  }
  .work-in-progress .delta.danger{color:var(--danger);}
  .work-in-progress .delta.success{color:var(--success);}
  .work-in-progress .metric .badge{
    width:40px;height:40px;
    border-radius:999px;
    background:#eaf3ff;
    border:1px solid #d6e8ff;
    display:grid;
    place-items:center;
    flex:0 0 auto;
    color:var(--primary);
  }
  .work-in-progress .table-wrap{
    overflow:auto;
    background:#fff;
    height:75%;
  }
  .work-in-progress table{
   margin-top: 20px;
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .work-in-progress thead th{
    background:#FAFAFA;
    color: #475569;
    font-weight: 600;
    font-size: 12px;
    text-align: left;
    padding: 10px 12px;
    border-bottom: 1px solid var(--line);
    white-space: nowrap;
  }
  .work-in-progress thead th:first-child{
    background:#FAFAFA;
  }
  .work-in-progress tbody td{
    padding:10px 12px;
    border-bottom:1px solid var(--line2);
    
  }
  .work-in-progress tbody tr:last-child td{border-bottom:none;}
  .work-in-progress td.num,.work-in-progress th.num{text-align:left;font-variant-numeric:tabular-nums;}
  .work-in-progress .chart-area{
    /* border:1px solid var(--line);
    border-radius:12px; */
    padding:12px 12px 8px;
    background:#fff;
  }
  .work-in-progress .chart-wrap{   position:relative;
    margin-top: 20px;}
  .work-in-progress .chart-tooltip{
    position:absolute;
    padding:6px 10px;
    background:#fff;
    color:#111827;
    font-size:12px;
    border-radius:8px;
    border:1px solid #e5e7eb;
    box-shadow:0 12px 20px rgba(15,23,42,.18);
    pointer-events:none;
    opacity:0;
    transform:translate(-50%,-120%);
    transition:opacity .15s ease;
    display:flex;
    flex-direction:column;
    gap:2px;
    z-index:5;
  }
  .work-in-progress .chart-tooltip strong{font-size:11px;font-weight:700;}
  .work-in-progress .chart-tooltip span{font-size:12px;}
  .work-in-progress .chart-tooltip.is-visible{opacity:1;}
  .work-in-progress .chart-note{
    font-size: 16px;
    color: var(--muted);
    margin-top: 6px;
  }
  .work-in-progress .card-head{
    display:flex;
    align-items:center;
    gap:8px;
    padding:12px 14px 8px;
    font-size:22px;
    font-weight:800;
    color:#585858;
  }
  .work-in-progress .ineligible-card .card-head{
    padding:14px 16px 10px;
    margin:0;
    gap:10px;
    color:#1f2b5b;
    font-weight:700;
  }
  .work-in-progress .stat-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    padding:10px 14px 14px;
  }
  .work-in-progress .stat-card{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px 14px;
    background:#fff;
    min-height:90px;
    display:flex;
    flex-direction:column;
    gap:10px;
    box-shadow:0 1px 2px rgba(16,24,40,.05);
  }
  .work-in-progress .stat-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .work-in-progress .stat-main{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .work-in-progress .stat-icon{
    width:38px;
    height:38px;
    border-radius:50%;
    background:rgba(46,144,250,.14);
    border:1px solid rgba(46,144,250,.25);
    color:var(--primary-2);
    display:grid;
    place-items:center;
    flex:0 0 auto;
  }
  .work-in-progress .stat-card .label{
    font-size:16px;
    color:#65758B;
    font-weight:600;
  }
  .work-in-progress .stat-card .value{
    font-size:16pt;
    font-weight:700;
    color:#344256;
  }
  .work-in-progress .stat-card .delta{
    font-size:10pt;
    font-weight:700;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .work-in-progress .table-card{padding:0;}
  .work-in-progress .table-card .head{padding:16px 18px 10px;}
  .work-in-progress .table-card .body{padding:0 18px 16px;}
  .work-in-progress .footer-row td{
    background:#FAFAFA;
    font-weight:600;
    color:#0b1220;
    border-top:1px solid var(--line);
  }
  .collateral-dynamic .work-in-progress .top-sku-total-row td{
    background:#FAFAFA;
    font-weight:600;
    color:#0b1220;
    border-top:1px solid var(--line);
    padding:10px 12px;
  }
  .work-in-progress .table-card + .table-card{margin-top:8px;}
  .work-in-progress .numR{text-align:left;}
  .work-in-progress .filters{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:flex-end;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .work-in-progress .filters .select{
    position:relative;
    display:inline-flex;
    align-items:center;
  }
  .work-in-progress .filters select{
    appearance:none;
    border:1px solid var(--line);
    background:#fff;
    border-radius:8px;
    padding:7px 34px 7px 10px;
    font-size:12px;
    color:#475467;
    min-width:120px;
    box-shadow:0 1px 2px rgba(16,24,40,.06);
  }
  .work-in-progress .filters select:focus{
    outline:2px solid rgba(46,144,250,.25);
    outline-offset:1px;
  }
  .work-in-progress .filters .caret{
    position:absolute;
    right:10px;
    pointer-events:none;
    color:#667085;
    display:grid;
    place-items:center;
  }
  .work-in-progress .filters .caret svg{
    width:12px;
    height:12px;
    stroke:currentColor;
    fill:none;
    stroke-width:2;
    stroke-linecap:round;
    stroke-linejoin:round;
  }
  @media (max-width:980px){
    .work-in-progress .grid-2{grid-template-columns:1fr;}
    .work-in-progress .metric-stack{flex-direction:column;}
  }
  .collateral-dynamic .page{padding: 0px 9px;
    gap: 0;    margin-top: -15px;}
    .badge svg {
    width: 24px;
    height: 24px;
}
.table-border {
    border: 1px solid var(--line);
    border-radius: 12px;
}
.work-in-progress .table-border th.num,
.work-in-progress .table-border td.num{
  text-align:center;
}
  .work-in-progress .ineligible-card .table-wrap{
    overflow:auto;
    border:1px solid #e3eaf7;
    border-left:0;
    border-right:0;
    border-radius:12px;
    background:#fff;
    box-shadow:none;
    height:auto;
  }
  .work-in-progress .ineligible-detail-table{
    width:100%;
    margin-top:0;
    border-collapse:collapse;
    font-size:12px;
    color:#475569;
  }
  .work-in-progress .ineligible-detail-table thead th{
    background:#f7faff;
    font-weight:700;
    color:#64748b;
    padding:10px 12px;
    border-bottom:1px solid #e3eaf7;
    text-align:center;
  }
  .work-in-progress .ineligible-detail-table thead th:first-child{
    border-left:1px solid #e3eaf7;
    border-top-left-radius:10px;
    text-align:left;
  }
  .work-in-progress .ineligible-detail-table thead th:last-child{
    border-right:1px solid #e3eaf7;
    border-top-right-radius:10px;
    text-align:center;
    width:160px;
  }
  .work-in-progress .ineligible-detail-table th:first-child{font-size:10pt;}
  .work-in-progress .ineligible-detail-table td{
    padding:10px 12px;
    border-bottom:1px solid #eef2f7;
    text-align:left;
    background:#fff;
    font-weight:600;
  }
  .work-in-progress .ineligible-detail-table td:first-child{
    border-left:1px solid #e3eaf7;
  }
  .work-in-progress .ineligible-detail-table td:last-child{
    border-right:1px solid #e3eaf7;
  }
  .work-in-progress .ineligible-detail-table td.num{
    text-align:center;
    font-variant-numeric:tabular-nums;
  }
  .work-in-progress .ineligible-detail-table tr:last-child td{border-bottom:0;}
  .work-in-progress .table-card{
    padding:0;
    border:1px solid #e6edf7;
    border-radius:14px;
    box-shadow:none;
  }
  .work-in-progress .table-card .head{padding:16px 18px 10px;}
  .work-in-progress .table-card .body{padding:0 18px 18px;}
  .work-in-progress .table-card .table-wrap{
    border:1px solid #e3eaf7;
    border-radius:12px;
    background:#fff;
    overflow:auto;
    height:auto;
  }
  .work-in-progress .table-card table{
    width:100%;
    margin-top:0;
    border-collapse:separate;
    border-spacing:0;
    font-size:12px;
    color:#475569;
  }
  .work-in-progress .table-card thead th{
    background:#f7faff;
    color:#6b7280;
    font-weight:700;
    padding:10px 12px;
    border-bottom:1px solid #e3eaf7;
    text-align:center;
    white-space:nowrap;
  }
  .work-in-progress .table-card thead th:first-child{
    text-align:left;
    border-left:1px solid #e3eaf7;
    border-top-left-radius:10px;
  }
  .work-in-progress .table-card thead th:last-child{
    border-right:1px solid #e3eaf7;
    border-top-right-radius:10px;
  }
  .work-in-progress .table-card tbody td{
    padding:10px 12px;
    border-bottom:1px solid #eef2fb;
    border-left:0;
    border-right:0;
    background:#fff;
    color:#65758B;
    font-weight:600;
    text-align:center;
    white-space:nowrap;
  }
  .work-in-progress .table-card tbody td:first-child{
    text-align:left;
  }
  .work-in-progress .table-card tbody tr:last-child td{
    border-bottom:1px solid #e3eaf7;
  }
  .work-in-progress .table-card tbody tr.footer-row td{
    color:#0b1220;
    font-weight:600;
    background-color: #f7faff;
  }
  .work-in-progress .table-card tfoot td{
    background:#f7faff;
    border-top:1px solid #e3eaf7;
    font-weight:600;
    color:#0b1220;
    padding:10px 12px;
    text-align:center;
  }
  .work-in-progress .table-card tfoot td:first-child{
    text-align:left;
  }
  .work-in-progress .category-analysis-table thead th:not(:first-child),
  .work-in-progress .category-analysis-table tbody td:not(:first-child){
    text-align:center;
  }
  .work-in-progress .category-analysis-table thead th:first-child,
  .work-in-progress .category-analysis-table tbody td:first-child{
    text-align:left;
  }
  .work-in-progress .category-analysis-table th.num,
  .work-in-progress .category-analysis-table td.num{
    text-align:center;
  }
  .work-in-progress .top-sku-table thead th:nth-child(4),
  .work-in-progress .top-sku-table thead th:nth-child(5),
  .work-in-progress .top-sku-table thead th:nth-child(6),
  .work-in-progress .top-sku-table thead th:nth-child(7),
  .work-in-progress .top-sku-table tbody td:nth-child(4),
  .work-in-progress .top-sku-table tbody td:nth-child(5),
  .work-in-progress .top-sku-table tbody td:nth-child(6),
  .work-in-progress .top-sku-table tbody td:nth-child(7),
  .work-in-progress .top-sku-table tfoot td:nth-child(4),
  .work-in-progress .top-sku-table tfoot td:nth-child(5),
  .work-in-progress .top-sku-table tfoot td:nth-child(6),
  .work-in-progress .top-sku-table tfoot td:nth-child(7){
    text-align:center;
  }
  .work-in-progress .top-sku-table thead th:nth-child(-n+3),
  .work-in-progress .top-sku-table tbody td:nth-child(-n+3),
  .work-in-progress .top-sku-table tfoot td:nth-child(-n+3){
    text-align:center;
  }
  .work-in-progress .top-sku-table thead th:nth-child(2),
  .work-in-progress .top-sku-table thead th:nth-child(3){
    text-align:center;
  }
  .work-in-progress .top-sku-table thead th:first-child,
  .work-in-progress .top-sku-table tbody td:first-child,
  .work-in-progress .top-sku-table tfoot td:first-child{
    text-align:left;
  }
</style>

<div class="page work-in-progress">
  <form class="filters" method="get">
    <input type="hidden" name="section" value="inventory">
    <input type="hidden" name="inventory_tab" value="work_in_progress">
    <label class="select">
      <select name="work_in_progress_range" aria-label="Date range" onchange="this.form.submit()">
        {% for option in work_in_progress_range_options %}
          <option value="{{ option.value }}" {% if option.value == work_in_progress_selected_range %}selected{% endif %}>
            {{ option.label }}
          </option>
        {% endfor %}
      </select>
      <span class="caret" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
      </span>
    </label>
    <label class="select">
      <select name="work_in_progress_division" aria-label="Division filter" onchange="this.form.submit()">
        {% for option in work_in_progress_division_options %}
          <option value="{{ option.value }}" {% if option.value == work_in_progress_selected_division %}selected{% endif %}>
            {{ option.label }}
          </option>
        {% endfor %}
      </select>
      <span class="caret" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
      </span>
    </label>
  </form>
  <div class="grid-2">
    <div class="card summary-card">
      <div class="card-head">
        <img src="{% static 'images/borrowing_icon.svg' %}" 
            alt="Available Inventory Icon"
            class="current-update-icon" />
        <h2 class="main-head">Available Inventory Breakdown</h2>
      </div>

      <div class="stat-grid">
        {% for metric in work_in_progress_metrics %}
          <div class="stat-card">
            <div class="stat-top">
              <div class="stat-main">
                <div class="label">{{ metric.label }}</div>
                <div class="value">{{ metric.value }}</div>
              </div>
              <div class="stat-icon" aria-hidden="true">
                {{ metric.icon|safe }}
              </div>
            </div>

            {% if metric.delta %}
              <div class="delta {{ metric.delta_class }}">
                <span>
                  {% if metric.symbol %}{{ metric.symbol }}{% endif %}
                  {{ metric.delta }}
                </span>
              </div>
            {% endif %}
          </div>
        {% empty %}
          <div class="stat-card">
            <div class="stat-top">
              <div class="stat-main">
                <div class="label">Awaiting data</div>
                <div class="value">??"</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="card summary-card ineligible-card">
      <div class="card-head">
        <img src="{% static 'images/borrowing_icon.svg' %}" 
            alt="Current Update Icon"
            class="current-update-icon" />
        <h2 class="main-head">Ineligible Details</h2>
      </div>
      <div class="table-wrap">
        <table class="ineligible-detail-table">
          <thead>
            <tr>
              <th>Ineligibles</th>
              <th class="num">Amount</th>
              <th class="num">% of Ineligibles</th>
            </tr>
          </thead>
          <tbody>
            {% for row in work_in_progress_ineligible_detail %}
              <tr>
                <td>{{ row.reason }}</td>
                <td class="num">{{ row.amount }}</td>
                <td class="num">{{ row.pct }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3">No ineligible detail.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card section">
    <div class="title">
      <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
      <h2 class="main-head">Inventory Trend</h2>
    </div>
    <div class="chart-area" data-chart="workInventoryTrend"></div>
    <div class="chart-note">Trend shows how available inventory has moved over the last 12 months.</div>
  </div>

  <div class="card table-card">
    <div class="head">
      <div class="title" style="margin:0;">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M4 16.5l6-6 4 4 6-7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 7h-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </span>
        <h2 class="main-head">Category Analysis</span>
      </div>
    </div>
    <div class="body">
      <div class="table-wrap">
        <table class="category-analysis-table">
          <thead>
            <tr>
              <th>Category</th>
              <th class="num">Total</th>
              <th class="num">Ineligible</th>
              <th class="num">Available</th>
              <th class="num">% Available</th>
            </tr>
          </thead>
          <tbody>
            {% for row in work_in_progress_category_rows %}
              <tr>
                <td>{{ row.label }}</td>
                <td class="num">{{ row.total }}</td>
                <td class="num">{{ row.ineligible }}</td>
                <td class="num">{{ row.available }}</td>
                <td class="num">{{ row.pct_available }}</td>
              </tr>
            {% endfor %}
            <tr class="footer-row">
              <td>{{ work_in_progress_category_top10.label }}</td>
              <td class="num">{{ work_in_progress_category_top10.total }}</td>
              <td class="num">{{ work_in_progress_category_top10.ineligible }}</td>
              <td class="num">{{ work_in_progress_category_top10.available }}</td>
              <td class="num">{{ work_in_progress_category_top10.pct_available }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card table-card">
    <div class="head">
      <div class="title" style="margin:0;">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M4 16.5l6-6 4 4 6-7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 7h-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </span>
        <h2 class="main-head">Top SKU Analysis</span>
      </div>
    </div>
    <div class="body">
      <div class="table-wrap">
        <table class="top-sku-table">
          <thead>
            <tr>
              <th>Item Number</th>
              <th>Category</th>
              <th>Description</th>
              <th class="num">Amount</th>
              <th class="num">Units</th>
              <th class="num">$ / Unit</th>
              <th class="num">% Available</th>
            </tr>
          </thead>
          <tbody>
            {% for sku in work_in_progress_top_skus %}
              <tr>
                <td>{{ sku.item_number }}</td>
                <td>{{ sku.category }}</td>
                <td>{{ sku.description }}</td>
                <td class="num">{{ sku.amount }}</td>
                <td class="num">{{ sku.units }}</td>
                <td class="num">{{ sku.per_unit }}</td>
                <td class="num">{{ sku.pct_available }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="num">No SKU data.</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="footer-row top-sku-total-row">
              <td>Top 20 Total</td>
              <td colspan="2"></td>
              <td class="num">{{ work_in_progress_top20_total.total }}</td>
              <td class="num"></td>
              <td class="num"></td>
              <td class="num">{{ work_in_progress_top20_total.pct_available }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const charts = {{ work_in_progress_chart_config_json|safe }};
  function fmtY(val, cfg, decimalsOverride){
    const decimals = Number.isFinite(decimalsOverride) ? decimalsOverride : (Number.isFinite(cfg.yDecimals) ? cfg.yDecimals : 1);
    const scale = Number.isFinite(cfg.yScale) ? cfg.yScale : 1;
    const value = Number(val);
    const scaled = Number.isFinite(value) ? value / scale : 0;
    const formatted = scaled.toLocaleString("en-US", {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals,
    });
    if (cfg.yPrefix || cfg.ySuffix) return `${cfg.yPrefix||""}${formatted}${cfg.ySuffix||""}`;
    return formatted;
  }
  function resolveYDecimals(cfg, range, ticks){
    const base = Number.isFinite(cfg.yDecimals) ? cfg.yDecimals : 1;
    const scale = Number.isFinite(cfg.yScale) ? cfg.yScale : 1;
    const step = (range / Math.max(1, (ticks || 6) - 1)) / scale;
    if (!Number.isFinite(step) || step <= 0) return base;
    let needed = 0;
    if (step < 1) {
      needed = Math.ceil(-Math.log10(step));
    }
    return Math.min(3, Math.max(base, needed));
  }
  function pathFrom(pts){
    return pts.map((p,i)=> (i===0?`M ${p[0]} ${p[1]}`:`L ${p[0]} ${p[1]}`)).join(" ");
  }
  function computePaddedBounds(values, padPct = 0.10){
    const filtered = values.filter((val) => Number.isFinite(val));
    if (!filtered.length) return null;
    let min = Math.min(...filtered);
    let max = Math.max(...filtered);
    if (min === max) {
      const padding = Math.abs(max) * padPct || 1;
      return { min: min - padding, max: max + padding };
    }
    const range = max - min;
    const pad = Math.max(range * padPct, 1);
    return { min: min - pad, max: max + pad };
  }
  function renderLine(el,c){
    if (!c.values || c.values.length < 1 || !c.labels || c.labels.length < 1) {
      el.innerHTML = `
        <div class="chart-wrap">
          <div class="card-pad">No data available.</div>
        </div>
      `;
      return;
    }
    const W = 1040, H = 320;
    const pad = {l:80,r:30,t:20,b:60};
    const plotW = W-pad.l-pad.r, plotH = H-pad.t-pad.b;
    const bounds = computePaddedBounds(c.values);
    let min = bounds ? bounds.min : Math.min(...c.values);
    let max = bounds ? bounds.max : Math.max(...c.values);
    const dataMin = Math.min(...c.values);
    if (dataMin >= 0 && min < 0) {
      min = 0;
    }
    const range = max - min || 1;
    const xDenominator = Math.max(1, c.labels.length - 1);
    const x = i => pad.l + (i / xDenominator) * plotW;
    const y = v => {
      const ratio = (v - min) / range;
      return pad.t + (1 - ratio) * plotH;
    };
    const points = c.values.map((v,i)=>[x(i),y(v)]);
    const ticks = c.yTicks||6;
    const yDecimals = resolveYDecimals(c, range, ticks);
    const yTicks = Array.from({length:ticks},(_,i)=>{
      const t = i/(ticks-1);
      const val = max - t * range;
      return {val, yy:y(val)};
    });
    const yTickLines = yTicks.map(t=>`
      <line x1="${pad.l}" y1="${t.yy}" x2="${W-pad.r}" y2="${t.yy}" stroke="#e7eef7" stroke-width="1"></line>
    `).join("");
    const yTickLabels = yTicks.map(t=>{
      const label = fmtY(t.val,c,yDecimals);
      return `<text x="55" y="${t.yy+4}" fill="#94a3b8" font-size="12" font-weight="400" text-anchor="end">${label}</text>`;
    }).join("");
    const xLabels = c.labels.map((lab,i)=>{
      const label = String(lab);
      return `<text x="${x(i)}" y="${H-20}" text-anchor="middle">${label}</text>`;
    }).join("");
    el.innerHTML = `
      <div class="chart-wrap">
        <svg viewBox="0 0 ${W} ${H}" role="img" aria-label="${c.title} chart">
          <defs>
            <clipPath id="clip-wip">
              <rect x="${pad.l}" y="${pad.t}" width="${plotW}" height="${plotH}" rx="8"></rect>
            </clipPath>
          </defs>
          ${yTickLines}
          ${yTickLabels}
          <path d="${pathFrom(points)}" fill="none" stroke="${c.color||'#1e6fe0'}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" clip-path="url(#clip-wip)"></path>
          ${points.map((p,i)=>`<circle cx="${p[0]}" cy="${p[1]}" r="4" fill="${c.color||'#1e6fe0'}" class="wip-point" data-label="${c.labels[i]}" data-value="${fmtY(c.values[i],c,yDecimals)}"></circle>`).join("")}
          <g fill="#94a3b8" font-size="12" font-weight="400">
            ${xLabels}
          </g>
        </svg>
        <div class="chart-tooltip" aria-hidden="true"></div>
      </div>
    `;
    attachWipTooltip(el);
  }
  function positionTooltip(el,event){
    const rect = el.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    return {x,y};
  }
  function attachWipTooltip(el){
    const wrap = el.querySelector(".chart-wrap");
    const tooltip = el.querySelector(".chart-tooltip");
    if (!wrap || !tooltip) return;
    const points = el.querySelectorAll(".wip-point");
    const show = (event)=>{
      const target = event.currentTarget;
      const label = (target.dataset.label||"").replace(/\n/g," ");
      const value = target.dataset.value||"";
      tooltip.innerHTML = `<strong>${value}</strong><span>${label}</span>`;
      const {x,y} = positionTooltip(wrap,event);
      tooltip.style.left = `${Math.max(14, Math.min(wrap.clientWidth-14, x))}px`;
      tooltip.style.top = `${Math.max(18, Math.min(wrap.clientHeight-14, y-12))}px`;
      tooltip.classList.add("is-visible");
    };
    const hide = ()=>tooltip.classList.remove("is-visible");
    points.forEach(point=>{
      point.style.cursor = "pointer";
      point.addEventListener("mousemove", show);
      point.addEventListener("mouseenter", show);
      point.addEventListener("mouseleave", hide);
      point.addEventListener("blur", hide);
    });
  }
  document.addEventListener("DOMContentLoaded", ()=>{
    const chartElements = document.querySelectorAll("[data-chart]");
    chartElements.forEach(el=>{
      const key = el.getAttribute("data-chart");
      if (charts[key]) {
        renderLine(el, charts[key]);
      }
    });
  });
</script>
