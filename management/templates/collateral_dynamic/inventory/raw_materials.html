<style>
  :root{
    --bg:#f6f9fd;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#6b7280;
    --line:#e7eef7;
    --line2:#f0f5fb;
    --primary:#1e6fe0;
    --primary-2:#2c7be5;
    --success:#16a34a;
    --danger:#ef4444;
    --shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    --radius:14px;
  }
  *{box-sizing:border-box;}
  .raw-materials .page{
    max-width:1120px;
    margin:18px auto;
    padding:0 14px 28px;
  }
  .raw-materials .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .raw-materials .section{
    padding:16px 18px;
    margin-bottom:14px;
  }
  .raw-materials .title{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:700;
    letter-spacing:0.1px;
    margin:2px 0 12px;
    color:#0b1220;
  }
  .raw-materials .title .icon{
    width:18px;height:18px;display:grid;place-items:center;
    color:var(--primary);
  }
  .raw-materials .top-grid{
    display:grid;
    grid-template-columns:360px 1fr;
    gap:14px;
    align-items:stretch;
  }
  .raw-materials .metric-stack{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .raw-materials .metric{
    border:1px solid var(--line);
    border-radius:12px;
    padding:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    min-height:86px;
    background:#fff;
  }
  .raw-materials .metric .label{
    font-size:12px;
    color:var(--muted);
    font-weight:600;
    margin-bottom:4px;
  }
  .raw-materials .metric .value{
    font-size:22px;
    font-weight:800;
    letter-spacing:0.2px;
    margin-bottom:6px;
  }
  .raw-materials .metric .delta{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:700;
  }
  .raw-materials .delta.danger{color:var(--danger);}
  .raw-materials .delta.success{color:var(--success);}
  .raw-materials .metric .badge{
    width:40px;height:40px;
    border-radius:999px;
    background:#eaf3ff;
    border:1px solid #d6e8ff;
    display:grid;
    place-items:center;
    flex:0 0 auto;
    color:var(--primary);
  }
  .raw-materials .table-wrap{
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    height:100%;
  }
  .raw-materials table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .raw-materials thead th{
    background:#f4f7fc;
    color:#475569;
    font-weight:800;
    font-size:12px;
    text-align:left;
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    white-space:nowrap;
  }
  .raw-materials tbody td{
    padding:10px 12px;
    border-bottom:1px solid var(--line2);
    color:#0f172a;
  }
  .raw-materials tbody tr:last-child td{border-bottom:none;}
  .raw-materials td.num,.raw-materials th.num{text-align:right;font-variant-numeric:tabular-nums;}
  .raw-materials .chart-area{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px 12px 8px;
    background:#fff;
  }
  .raw-materials .chart-wrap{
    position:relative;
  }
  .raw-materials .chart-tooltip{
    position:absolute;
    left:0;
    top:0;
    min-width:88px;
    padding:6px 10px;
    background:var(--text);
    color:#fff;
    border-radius:8px;
    font-size:12px;
    pointer-events:none;
    opacity:0;
    transform:translate(-50%,-110%);
    transition:opacity .2s ease;
    box-shadow:0 12px 24px rgba(15,23,42,.2);
    z-index:5;
  }
  .raw-materials .chart-tooltip strong{
    font-size:11px;
    display:block;
    margin-bottom:2px;
  }
  .raw-materials .chart-tooltip span{
    font-size:12px;
    font-weight:600;
  }
  .raw-materials .chart-tooltip.is-visible{
    opacity:1;
  }
  .raw-materials .chart-note{
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
  }
  .raw-materials .table-card{padding:0;}
  .raw-materials .table-card .head{padding:16px 18px 10px;}
  .raw-materials .table-card .body{padding:0 18px 16px;}
  .raw-materials .footer-row td{
    background:#fbfdff;
    font-weight:800;
    color:#0b1220;
    border-top:1px solid var(--line);
  }
  .raw-materials .numR{text-align:right;}
</style>

<div class="page raw-materials">

  <div class="card section">
    <div class="title">
      <span class="icon" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M4 16.5l6-6 4 4 6-7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 7h-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/></svg>
      </span>
      <span>Available Inventory Breakdown</span>
    </div>

    <div class="top-grid">
      <div class="metric-stack">
        {% for metric in raw_materials_metrics %}
          <div class="metric">
            <div>
              <div class="label">{{ metric.label }}</div>
              <div class="value">{{ metric.value }}</div>
              {% if metric.delta %}
                <div class="delta {{ metric.delta_class }}">
                  <span aria-hidden="true">{{ metric.symbol }}</span>
                  <span>{{ metric.delta }}</span>
                </div>
              {% endif %}
            </div>
            <div class="badge" aria-hidden="true" title="{{ metric.label }}">
              {{ metric.icon|safe }}
            </div>
          </div>
        {% empty %}
          <div class="metric">
            <div>
              <div class="label">Awaiting data</div>
              <div class="value">â€”</div>
            </div>
            <div class="badge"></div>
          </div>
        {% endfor %}
      </div>

      <div class="table-wrap">
        <div style="padding:14px 14px 6px;">
          <div class="title" style="margin:0;">
            <span class="icon" aria-hidden="true">
              <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
            </span>
            <span>Ineligible Detail</span>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Ineligibles</th>
              <th class="num">Amount</th>
              <th class="num">% of Ineligibles</th>
            </tr>
          </thead>
          <tbody>
            {% for row in raw_materials_ineligible_detail %}
              <tr>
                <td>{{ row.reason }}</td>
                <td class="num">{{ row.amount }}</td>
                <td class="num">{{ row.pct }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3">No ineligible detail.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card section">
    <div class="title">
      <span class="icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
          <path d="M4 16.5l6-6 4 4 6-7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M20 7h-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </span>
      <span>Inventory Trend</span>
    </div>
    <div class="chart-area" data-chart="rawInventoryTrend"></div>
    <div class="chart-note">Trend shows how available inventory has moved over the last 12 months.</div>
  </div>

  <div class="card table-card">
    <div class="head">
      <div class="title" style="margin:0;">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M4 16.5l6-6 4 4 6-7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 7h-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </span>
        <span>Category Analysis</span>
      </div>
    </div>
    <div class="body">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th class="num">Total</th>
              <th class="num">Ineligible</th>
              <th class="num">Available</th>
              <th class="num">% Available</th>
            </tr>
          </thead>
          <tbody>
            {% for row in raw_materials_category_rows %}
              <tr>
                <td>{{ row.label }}</td>
                <td class="num">{{ row.total }}</td>
                <td class="num">{{ row.ineligible }}</td>
                <td class="num">{{ row.available }}</td>
                <td class="num">{{ row.pct_available }}</td>
              </tr>
            {% endfor %}
            <tr class="footer-row">
              <td>{{ raw_materials_category_top10.label }}</td>
              <td class="num">{{ raw_materials_category_top10.total }}</td>
              <td class="num">{{ raw_materials_category_top10.ineligible }}</td>
              <td class="num">{{ raw_materials_category_top10.available }}</td>
              <td class="num">{{ raw_materials_category_top10.pct_available }}</td>
            </tr>
            <tr class="footer-row">
              <td>{{ raw_materials_category_other.label }}</td>
              <td class="num">{{ raw_materials_category_other.total }}</td>
              <td class="num">{{ raw_materials_category_other.ineligible }}</td>
              <td class="num">{{ raw_materials_category_other.available }}</td>
              <td class="num">{{ raw_materials_category_other.pct_available }}</td>
            </tr>
            <tr class="footer-row">
              <td>Total</td>
              <td class="num">{{ raw_materials_category_footer.total }}</td>
              <td class="num">{{ raw_materials_category_footer.ineligible }}</td>
              <td class="num">{{ raw_materials_category_footer.available }}</td>
              <td class="num">{{ raw_materials_category_footer.pct_available }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card table-card">
    <div class="head">
      <div class="title" style="margin:0;">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path d="M4 16.5l6-6 4 4 6-7" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 7h-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </span>
        <span>Top SKU Analysis</span>
      </div>
    </div>
    <div class="body">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Category</th>
              <th>Description</th>
              <th class="num">Amount</th>
              <th class="num">Units</th>
              <th class="num">$ / Unit</th>
              <th class="num">% Available</th>
            </tr>
          </thead>
          <tbody>
            {% for sku in raw_materials_top_skus %}
              <tr>
                <td>{{ sku.sku }}</td>
                <td>{{ sku.category }}</td>
                <td>{{ sku.description }}</td>
                <td class="num">{{ sku.amount }}</td>
                <td class="num">{{ sku.units }}</td>
                <td class="num">{{ sku.per_unit }}</td>
                <td class="num">{{ sku.pct_available }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="num">No SKU data.</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="footer-row">
              <td>Top 25 Total</td>
              <td class="num" colspan="4"></td>
              <td class="num">{{ raw_materials_top25_total.total }}</td>
              <td class="num">{{ raw_materials_top25_total.pct_available }}</td>
            </tr>
            <tr class="footer-row">
              <td>Other items</td>
              <td class="num" colspan="4"></td>
              <td class="num">{{ raw_materials_top_skus_other.total }}</td>
              <td class="num">{{ raw_materials_top_skus_other.pct_available }}</td>
            </tr>
            <tr class="footer-row">
              <td>Total</td>
              <td class="num" colspan="4"></td>
              <td class="num">{{ raw_materials_top_skus_total.total }}</td>
              <td class="num">{{ raw_materials_top_skus_total.pct_available }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
  const charts = {{ raw_materials_chart_config_json|safe }};
  function fmtY(v,c){
    if (c.yPrefix || c.ySuffix) return `${c.yPrefix||""}${v.toFixed(1)}${c.ySuffix||""}`;
    return String(v.toFixed(1));
  }
  function pathFrom(pts){
    return pts.map((p,i)=> (i===0?`M ${p[0]} ${p[1]}`:`L ${p[0]} ${p[1]}`)).join(" ");
  }
  function renderLine(el,c){
    const W = 1040, H = 320;
    const pad = {l:80,r:30,t:20,b:60};
    const plotW = W-pad.l-pad.r, plotH = H-pad.t-pad.b;
    let min = Math.min(...c.values);
    let max = Math.max(...c.values);
    if (max - min < 10) {
      const padding = 5;
      min = min - padding;
      max = max + padding;
    }
    const range = max - min || 1;
    const x = i => pad.l + (i/(c.labels.length-1))*plotW;
    const y = v => {
      const ratio = (v - min) / range;
      return pad.t + (1 - ratio) * plotH;
    };
    const points = c.values.map((v,i)=>[x(i),y(v)]);
    const ticks = c.yTicks||6;
    const yTicks = Array.from({length:ticks},(_,i)=>{
      const t = i/(ticks-1);
      const val = max - t * range;
      return {val, yy:y(val)};
    });
    el.innerHTML = `
      <div class="chart-wrap">
        <svg viewBox="0 0 ${W} ${H}" role="img" aria-label="${c.title} chart">
          <defs>
            <clipPath id="clip">
              <rect x="${pad.l}" y="${pad.t}" width="${plotW}" height="${plotH}" rx="8"></rect>
            </clipPath>
          </defs>
          ${yTicks.map(t=>`
            <line x1="${pad.l}" y1="${t.yy}" x2="${W-pad.r}" y2="${t.yy}" stroke="#e7eef7" stroke-width="1"></line>
            <text x="55" y="${t.yy+4}" fill="#94a3b8" font-size="12" font-weight="700" text-anchor="end">${fmtY(t.val,c)}</text>
          `).join("")}
          <path d="${pathFrom(points)}" fill="none" stroke="${c.color||'#1e6fe0'}" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" clip-path="url(#clip)"></path>
          ${points.map((p,i)=>`<circle cx="${p[0]}" cy="${p[1]}" r="6" fill="${c.color||'#1e6fe0'}"
            data-label="${c.labels[i]}" data-value="${fmtY(c.values[i],c)}"
            class="raw-trend-point"></circle>`).join("")}
          <g fill="#94a3b8" font-size="12" font-weight="700">
            ${c.labels.map((lab,i)=>`<text x="${x(i)}" y="${H-20}" text-anchor="middle">${lab}</text>`).join("")}
          </g>
        </svg>
        <div class="chart-tooltip" aria-hidden="true"></div>
      </div>
    `;
    attachTrendTooltips(el);
  }

  function attachTrendTooltips(el){
    const tooltip = el.querySelector(".chart-tooltip");
    if(!tooltip) return;
    const points = el.querySelectorAll(".raw-trend-point");
    const show = (event) =>{
      const target = event.currentTarget;
      const label = target.dataset.label||"";
      const value = target.dataset.value||"";
      tooltip.innerHTML = `<strong>${value}</strong><span>${label}</span>`;
      const rect = el.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      tooltip.style.left = `${Math.max(12, Math.min(rect.width-12, x))}px`;
      tooltip.style.top = `${Math.max(18, y-10)}px`;
      tooltip.classList.add("is-visible");
    };
    const hide = () => tooltip.classList.remove("is-visible");
    points.forEach(point=>{
      point.style.cursor="pointer";
      point.addEventListener("mousemove", show);
      point.addEventListener("mouseenter", show);
      point.addEventListener("mouseleave", hide);
      point.addEventListener("blur", hide);
    });
  }
  document.querySelectorAll("[data-chart]").forEach(el=>{
    const key = el.getAttribute("data-chart");
    const c = charts[key];
    if(!c) return;
    if(c.type==="line") renderLine(el,c);
  });
</script>
