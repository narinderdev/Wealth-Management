{% extends "layout/app_base.html" %}
{% load static %}
{% block title %}Collateral Dynamic{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    .ar-graph {
      width: 100%;
      margin-top: 8px;
    }
    .collateral-dynamic{
      --cd-panel:#ffffff;
      --cd-muted:#6b7280;
      --cd-accent:#0a6af0;
      --cd-line:#e5edf6;
      --cd-ink:#1f2937;
      --cd-shadow:0 4px 12px rgba(15,23,42,.04);
      --blue:#1d4089;
      --blue-2:#2b6ff7;
      --blue-3:#0b5bd3;
      --teal:#1aa37a;
      --purple:#8b3aa8;
    }
    .collateral-dynamic .section-tabs{
      display:flex;
      gap:12px;
      margin-top:12px;
      font-size:12px;
      text-transform:uppercase;
    }
    .collateral-dynamic .section-tab{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid transparent;
      background:var(--cd-panel);
      color:var(--cd-muted);
      font-weight:500;
      text-decoration:none;
    }
    .collateral-dynamic .section-tab.active{
      color:var(--cd-accent);
      border-color:var(--cd-line);
      box-shadow:0 8px 16px rgba(15,23,42,.08);
    }
    .collateral-dynamic .section-content{
      margin-top:18px;
    }
    .collateral-dynamic .layout{
      display:grid;
      grid-template-columns:240px 1fr;
      gap:20px;
    }
    .collateral-dynamic .menu-card{

    width: 255px;
    margin-top: 14px;
    height: 382px;
      background:#fff;
      border-radius:18px;
      padding:16px;
      box-shadow:0 12px 30px rgba(15,23,42,.1);
    }
    .collateral-dynamic .menu-card .menu-title{
      font-size:12px;
      font-weight:600;
      color:#737791;
      margin-bottom:16px;
      letter-spacing:.2px;
    }
    .collateral-dynamic .menu-item{
      width:100%;
      border:none;
      background:transparent;
      padding:10px 12px;
      border-radius:12px;
      display:flex;
      align-items:center;
      gap:12px;
      font-size:14px;
      color:#475569;
      cursor:pointer;
      text-decoration:none;
      transition:background .2s ease,color .2s ease;
    }
    .collateral-dynamic .menu-item img{
      width:18px;
      height:18px;
      flex-shrink:0;
    }
    .collateral-dynamic .menu-item.menu-static{
      cursor:default;
      pointer-events:none;
      color:#64748b;
    }
    .collateral-dynamic .menu-item.inventory-header.is-active{
      background:transparent;
      color:var(--blue);
      font-weight:600;
    }
    .collateral-dynamic .menu-item.inventory-header.is-active img{
      filter:none;
    }
    .collateral-dynamic .menu-item.menu-toggle{
      text-align:left;
    }
    .collateral-dynamic .menu-item.menu-toggle .menu-caret{
      margin-left:auto;
      width:8px;
      height:8px;
      border-right:2px solid #94a3b8;
      border-bottom:2px solid #94a3b8;
      transform:rotate(45deg);
      transition:transform .2s ease, border-color .2s ease;
    }
    .collateral-dynamic .menu-item.menu-toggle[aria-expanded="true"] .menu-caret{
      transform:rotate(-135deg);
      border-color:#0b2a66;
    }
    .collateral-dynamic .menu-item.active{
      background:var(--blue);
      color:#fff;
      font-weight:600;
      border-radius:1px;
    }
    .collateral-dynamic .menu-item.active img{
      filter:brightness(0) invert(1);
    }
    .collateral-dynamic .menu-item.menu-toggle.active{
      background:transparent;
      color:#0b2a66;
    }
    .collateral-dynamic .menu-item.menu-toggle.active img{
      filter:none;
    }
    .collateral-dynamic .menu-item.sub.active{
      background:var(--blue);
      color:#fff;
      font-weight:600;
      border-radius:1px;
    }
    .collateral-dynamic .menu-item.sub.active img{
      filter:brightness(0) invert(1);
    }
    .collateral-dynamic .menu-icon{
      width:24px;
      height:24px;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#eef2ff;
      color:#0b2a66;
      font-size:12px;
    }
    .collateral-dynamic .menu-group-label{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
      font-weight:600;
      color:#0b2a66;
    }
    .collateral-dynamic .menu-sublist{
      display:none;
      flex-direction:column;
      gap:0;
      margin-top:4px;
      padding-left:6px;
    }
    .collateral-dynamic .menu-sublist.is-open{
      display:flex;
    }
    .collateral-dynamic .menu-item.sub{
      padding-left:26px;
      font-size:13px;
      border-radius:0;
    }
    .collateral-dynamic .menu-item.sub + .menu-item.sub{
      border-top:1px solid #eef1f6;
    }
    .collateral-dynamic .menu-divider{
      height:1px;
      background:#eef1f6;
      margin:10px 0;
    }
    .collateral-dynamic .inventory-sublist{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:12px;
      padding-left:14px;
    }
    .collateral-dynamic .inventory-subitem{
      border-radius:12px;
      padding:10px 16px;
      background:#f5f7fb;
      color:#475569;
      font-weight:600;
      text-decoration:none;
      transition:background .2s ease;
      font-size:13px;
    }
    .collateral-dynamic .inventory-subitem.active{
      background:#0b2a66;
      color:#fff;
      box-shadow:0 6px 12px rgba(15,23,42,.2);
    }
    .collateral-dynamic .panel{
      background:var(--cd-panel);
      border:1px solid var(--cd-line);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--cd-shadow);
      margin-bottom:18px;
    }
    .collateral-dynamic .page{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .collateral-dynamic .card{
      background:#fff;
      border:1px solid var(--cd-line);
      border-radius:12px;
      box-shadow:var(--cd-shadow);
      padding:12px;
      margin-bottom:20px;
    }
    .collateral-dynamic .snapshot-card{
      padding:16px 18px 18px;
    }
    .collateral-dynamic .snapshot-card .cardHeader{
      padding-bottom:12px;
    }
    .collateral-dynamic .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:6px;
      border-bottom:1px solid #eef1f7;
    }
    .collateral-dynamic .hleft{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size:24px;
      color:#1f2a37;
    }
    .collateral-dynamic .spark{
      width:14px;
      height:14px;
      color:var(--cd-accent);
    }
    .collateral-dynamic .snapshotText{
      font-size:10pt;
      color:#737791;
      line-height:1.5;
      padding:8px 0 0 28px;
    }
    .collateral-dynamic .grid2{
      display:grid;
      grid-template-columns:260px 1fr;
      gap:12px;
    }
    .collateral-dynamic .smallTitle{
      font-size:10px;
      font-weight:600;
      color:#737791;
      padding-bottom:8px;
    }
    .collateral-dynamic .donutWrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      padding:10px 0 0 0;
    }
    .collateral-dynamic .donutCard{
      position:relative;
      width:190px;
      height:190px;
    }
    .collateral-dynamic .donutBox{
      position:relative;
      width:190px;
      height:190px;
      display:grid;
      place-items:center;
    }
    .collateral-dynamic .donutCenter{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:800;
      font-size:18px;
      text-align:center;
      padding:0 8px;
      font-variant-numeric:tabular-nums;
    }
    .collateral-dynamic .bars{
      width:90%;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .collateral-dynamic .barRow{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .collateral-dynamic .barLine{
          height: 34px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 0 10px;
    color: #ffffff;
    font-weight: 600;
    font-size: 10pt;
    letter-spacing: .2px;
}
.page-content{
      padding: 15px;
}
    .collateral-dynamic .barLine span{display:flex;align-items:center;gap:4px}
    .collateral-dynamic .barLine .dot{display:none}
    .collateral-dynamic .barLine.navy{background:#116BFD;}
    .collateral-dynamic .barLine.mid{background:#0753B2;}
    .collateral-dynamic .barLine.bright{background:#CADFEF;color:#1f2a37;}
    .collateral-dynamic .legend{
      display:flex;
      gap:12px;
      align-items:center;
      font-size:10px;
      color:#6b7280;
    }
    .collateral-dynamic .legItem{
      display:flex;
      gap:6px;
      align-items:center;
      /* text-transform:uppercase; */
      font-size:14px;
      letter-spacing:.3px;
    }
    .collateral-dynamic .legend-link{
      color:inherit;
      text-decoration:none;
    }
    .collateral-dynamic .legend-link:hover,
    .collateral-dynamic .legend-link:focus{
      text-decoration:underline;
    }
    .collateral-dynamic .sw{
      width:13px;
      height:13px;
      border-radius:2px;
      display:inline-block;
    }
    .collateral-dynamic .sw.navy{background:#116BFD}
    .collateral-dynamic .sw.mid{background:#0753B2}
    .collateral-dynamic .sw.bright{background:#CADFEF}
    .collateral-dynamic .chartPad{
      padding:12px 6px 4px 6px;
    }
    .collateral-dynamic .svgBox{
      width:100%;
      height:100%;
      border-radius:10px;
      background:#fff;
    }
    .collateral-dynamic .axisText{
      font-size:10pt;
      fill:#9aa7b8;
    }
    .collateral-dynamic .gridLine{
      stroke:#eef2f7;
      stroke-width:1;
    }
    .collateral-dynamic .tableWrap{
      padding:8px 4px 8px 4px;
    }
    .collateral-dynamic table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      color:#374151;
    }
    .collateral-dynamic thead th{
      font-weight:600;
      color:#6b7280;
      padding:10px 10px;
      border-bottom:1px solid #f0f4fa;
      text-align:left;
    }
    .collateral-dynamic tbody td{
      padding:10px 4px;
      border-bottom:1px solid #f0f4fa;
      background:#FAFAFA;
    font-weight:600;
    color:#0b1220;
    border-top:1px solid #e7eef7;
    font-size:13px;
      text-align:left;
    }
    .collateral-dynamic tbody tr:last-child td{
      border-bottom:none;
    }
    .collateral-dynamic .recovery-table{
      table-layout:fixed;
    }
    .collateral-dynamic .recovery-table th,
    .collateral-dynamic .recovery-table td{
      text-align:center;
    }
    .collateral-dynamic .recovery-table th:first-child,
    .collateral-dynamic .recovery-table td:first-child{
      text-align:left;
      font-size: 10pt;
    }
    .collateral-dynamic .recovery-table thead tr.tblGroup th{
      text-align:center;
      font-size: 10pt;
      font-weight:700;
      border-bottom:none;
      padding-bottom:2px;
    }
    .collateral-dynamic .recovery-table thead tr.tblGroup th:first-child{
      text-align:left;
    }
    .collateral-dynamic .recovery-table thead tr.tblSub th{
     font-size: 12px;
    color: #94a3b8;
    font-weight: 700;
    letter-spacing: .2px;
    padding-top: 2px;
    }
    .collateral-dynamic .mt12{
      margin-top:12px;
    }
    .collateral-dynamic .value-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
      margin-top:12px;
    }
    .collateral-dynamic .value-card{
      border:1px solid #f0f4fa;
      border-radius:10px;
      padding:12px;
      background:#f8fafc;
    }
    .collateral-dynamic .value-card .label{
      font-size:10px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .collateral-dynamic .value-card .value{
      font-size:18px;
      font-weight:700;
      margin-top:4px;
      color:#111827;
    }
    .collateral-dynamic .value-card .trend{
      font-size:11px;
      margin-top:4px;
      color:#16a34a;
    }
    .collateral-dynamic .value-card .trend.down{
      color:#dc2626;
    }
    .collateral-dynamic .table-card{
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:hidden;
      margin-top:12px;
    }
    .collateral-dynamic .stats-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:16px;
      margin-bottom:12px;
      margin-top:12px;
    }
    .collateral-dynamic .chart-card header{
      font-size:12px;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .collateral-dynamic .panel-header{
      display:flex;align-items:center;gap:10px;
      font-size:14px;font-weight:600;
      margin-bottom:14px;
      color:var(--cd-ink);
    }
    .collateral-dynamic .panel-header svg{width:16px;height:16px;stroke:var(--cd-accent)}
    .collateral-dynamic .snapshot-text{
      font-size:13px;
      color:#475569;
      line-height:1.6;
      margin-bottom:16px;
    }
    .collateral-dynamic .snapshot-grid{
      display:grid;
      grid-template-columns:220px 1fr;
      gap:20px;
    }
    .collateral-dynamic .donut-card{
      border:1px solid var(--cd-line);
      border-radius:12px;
      padding:12px;
      text-align:center;
    }
    .collateral-dynamic .donut-card .total{
      font-size:24px;font-weight:700;margin:8px 0;
    }
    .collateral-dynamic .donut-card .labels{
      margin-top:12px;
      text-align:left;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:#475569;
    }
    .collateral-dynamic .legend-dot{
      width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;
    }
    .collateral-dynamic .chart-card{
      border:1px solid var(--cd-line);
      border-radius:12px;
      padding:12px;
    }
    .collateral-dynamic .chart-wrap{position:relative;}
    .collateral-dynamic .chart-tooltip{
      position:absolute;
      padding:6px 10px;
      background:#ffffff;
      color:#111827;
      font-size:12px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      box-shadow:0 12px 22px rgba(15,23,42,.2);
      pointer-events:none;
      opacity:0;
      transform:translate(-50%,-120%);
      transition:opacity .15s ease;
      display:flex;
      flex-direction:column;
      gap:2px;
      z-index:5;
    }
    .collateral-dynamic .chart-tooltip strong{font-size:11px;font-weight:700;}
    .collateral-dynamic .chart-tooltip span{font-size:12px;}
    .collateral-dynamic .chart-tooltip.is-visible{opacity:1;}
    .collateral-dynamic .chart-card header{
      font-size:13px;
      font-weight:600;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      color:var(--cd-ink);
    }
    .collateral-dynamic .value-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap:12px;
      margin-bottom:12px;
    }
    .collateral-dynamic .value-card{
      border:1px solid var(--cd-line);
      border-radius:10px;
      padding:12px;
      background:#fafcff;
    }
    .collateral-dynamic .value-card .label{
      font-size:11px;
      color:var(--cd-muted);
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .collateral-dynamic .value-card .value{
      font-size:18px;
      font-weight:600;
      margin-top:6px;
      color:var(--cd-ink);
    }
    .collateral-dynamic .value-card .trend{
      font-size:12px;
      margin-top:4px;
      color:#16a34a;
    }
    .collateral-dynamic .value-card .trend.down{color:#dc2626}
    .collateral-dynamic .table-card{
      border:1px solid var(--cd-line);
      border-radius:12px;
      overflow:hidden;
    }
    .collateral-dynamic .stats-row{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap:16px;
    }
    .collateral-dynamic table{
      width:100%;
      border-collapse:collapse;
      font-size:10pt;
      color:#475569;
    }
    .collateral-dynamic th,
    .collateral-dynamic td{
      padding:10px 3px;
      text-align:left;
    background:#FAFAFA;
    font-weight:600;
    color:#0b1220;
    border-top:1px solid #e7eef7;
    font-size:13px;
    }
    .collateral-dynamic th{
      background:#f9fbff;
      color:#6b7280;
      font-weight:600;
    }
    .collateral-dynamic tbody tr:last-child td{border-bottom:none}
    .collateral-dynamic .placeholder-panel{
      min-height:280px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:flex-start;
      gap:8px;
      color:#475569;
    }
    .collateral-dynamic .placeholder-panel p{
      margin:0;
      font-size:13px;
      line-height:1.5;
      color:#475569;
    }
    .collateral-dynamic .ar-section{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .collateral-dynamic .ar-section .card{
      background:#fff;
      border:1px solid #dfe4f2;
      border-radius: 11px;
      margin-top: 17px;
    }
    .collateral-dynamic .ar-section .h2{
      font-size:1.5em;
      font-weight:700;
      margin:0 0 18px;
      display:flex;
      align-items:center;
      gap:8px;
      color:#585858;
    }
    .collateral-dynamic .ar-section .p{
      margin:0;
      font-size:10pt;
      color:#737791;
      line-height:1.6;
    }
    .collateral-dynamic .ar-section .filters{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .collateral-dynamic .ar-section .filters .select{
      position:relative;
      display:inline-flex;
      align-items:center;
    }
    .collateral-dynamic .ar-section .filters select{
      appearance:none;
      border:1px solid var(--cd-line);
      background:#fff;
      border-radius:8px;
      padding:7px 34px 7px 10px;
      font-size:12px;
      color:#475467;
      min-width:120px;
      box-shadow:var(--cd-shadow);
    }
    .collateral-dynamic .ar-section .filters select:focus{
      outline:2px solid rgba(46,144,250,.25);
      outline-offset:1px;
    }
    .collateral-dynamic .ar-section .filters .caret{
      position:absolute;
      top:50%;
      right:10px;
      pointer-events:none;
      color:#667085;
      display:grid;
      place-items:center;
      transform:translateY(-50%);
    }
    .collateral-dynamic .ar-section .filters .caret svg{
      width:12px;
      height:12px;
      stroke:currentColor;
      fill:none;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .collateral-dynamic .borrowing-base-insight{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px;
    }
    .collateral-dynamic .borrowing-base-column{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .collateral-dynamic .borrowing-base-kpi{
      border:1px solid #dfe4f2;
      border-radius:14px;
      background:#ffffff;
      padding:40px 16px;
      position:relative;
      box-shadow:0 14px 26px rgba(15,23,42,.06);
    }
    .collateral-dynamic .borrowing-base-kpi .kpi-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .collateral-dynamic .borrowing-base-kpi .kpi-label{
        font-size: 14pt;
    font-weight: 600;
    color: #65758B;
    }
    .collateral-dynamic .borrowing-base-kpi .kpi-value{
      margin-top: 16px;
      font-size: 14pt;
      font-weight: 700;
      color: #101a3c;
    }
    .collateral-dynamic .borrowing-base-kpi .kpi-delta{
      font-size:11px;
      font-weight:700;
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .collateral-dynamic .borrowing-base-kpi .kpi-delta.up{margin-top: 20px;color:var(--teal);font-size: 10pt;}
    .collateral-dynamic .borrowing-base-kpi .kpi-delta.down{margin-top: 20px;color:#e05555;font-size: 10pt;}
    .collateral-dynamic .borrowing-base-kpi .kpi-icon{
      width:36px;
      height:36px;
      border-radius:999px;
      background:#dbeafe;
      display:grid;
      place-items:center;
      flex-shrink:0;
    }
    .collateral-dynamic .borrowing-base-kpi .kpi-icon img{
      width:18px;
      height:18px;
    }
    .collateral-dynamic .borrowing-base-kpi .kpi-tooltip{
      position:absolute;
      left:16px;
      bottom:-8px;
      transform:translateY(100%);
      background:#fff;
      color:#111827;
      padding:8px 10px;
      border-radius:8px;
      font-size:12px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow:0 12px 24px rgba(15,23,42,.16);
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease;
      display:flex;
      flex-direction:column;
      gap:2px;
      z-index:6;
    }
    .collateral-dynamic .borrowing-base-kpi:hover .kpi-tooltip{
      opacity:1;
    }
    
    .collateral-dynamic .borrowing-base-chart .chart-box{
      background:#f8fafc;
      border-radius:10px;
      overflow:visible;
    }
    .collateral-dynamic .chart-box{
      position:relative;
      width:100%;
      aspect-ratio:var(--chart-width) / var(--chart-height);
    }
    .collateral-dynamic .chart-canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      z-index:2;
    }
    .collateral-dynamic .chart-layer{
      position:absolute;
      inset:0;
      z-index:3;
      width:100%;
      height:102%;
    }
    .collateral-dynamic .chart-layer.is-static{
      pointer-events:none;
      z-index:1;
    }
    .collateral-dynamic .chart-layer.label-layer{
      z-index:4;
margin-top: -5px;
margin-left: -15px;
    }
    .collateral-dynamic .chart-layer.line-layer{
      z-index:2;
      pointer-events:none;
    }
    .collateral-dynamic .chart-line-segment{
      position:absolute;
      height:2px;
      background:var(--line-color, #0b5bd3);
      border-radius:999px;
      transform-origin:0 50%;
    }
    .collateral-dynamic .chart-grid-line{
      position:absolute;
      background:#e6edf7;
    }
    .collateral-dynamic .chart-grid-line.h{
      left:calc(var(--axis-left) * 100% / var(--chart-width));
      width:calc((var(--axis-right) - var(--axis-left)) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      height:1px;
    }
    .collateral-dynamic .chart-grid-line.v{
      top:calc(var(--axis-top) * 100% / var(--chart-height));
      height:calc((var(--axis-bottom) - var(--axis-top)) * 100% / var(--chart-height));
      left:calc(var(--x) * 100% / var(--chart-width));
      width:1px;
    }
    .collateral-dynamic .chart-grid-line.axis-line{
      background:var(--axis-color, #e6edf7);
    }
    .collateral-dynamic .chart-axis-label{
      position:absolute;
      font-size:10pt;
      color:#9aa6b2;
      white-space:nowrap;
      pointer-events:none;
    }
    .collateral-dynamic .chart-axis-label.y{
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      transform:translate(0, -50%);
    }
    .collateral-dynamic .chart-axis-label.y.end{
      transform:translate(-100%, -50%);
    }
    .collateral-dynamic .chart-axis-label.x{
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      transform:translate(-50%, 0);
    }
    .collateral-dynamic .chart-axis-label.x.start{
      transform:translate(0, 0);
    }
    .collateral-dynamic .chart-axis-label.stack{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      line-height:1.1;
    }
    .collateral-dynamic .chart-axis-label.stack.center{
      margin-top: -32px;
      align-items:center;
      gap:2px;
    }
    .collateral-dynamic .chart-axis-year{
      font-size:10px;
      color:#9aa6b2;
    }
    .collateral-dynamic .chart-empty{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%, -50%);
      font-size:12px;
      color:rgba(15,23,42,.45);
      white-space:nowrap;
    }
    .collateral-dynamic .chart-dot{
      position:absolute;
      width:6px;
      height:6px;
      border-radius:50%;
      background:#fff;
      border:2px solid var(--dot-color, var(--blue-3));
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      transform:translate(-50%, -50%);
      pointer-events:none;
    }
    .collateral-dynamic .chart-hit{
      position:absolute;
      width:18px;
      height:18px;
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      transform:translate(-50%, -50%);
      background:transparent;
    }
    .collateral-dynamic .borrowing-base-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
    }
    .collateral-dynamic .borrowing-base-card{
      border:1px solid #dfe4f2;
      border-radius:18px;
      padding:16px;
      box-shadow:0 20px 30px rgba(15,23,42,.08);
      background:linear-gradient(180deg,#ffffff,#f7fbff);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .collateral-dynamic .borrowing-base-card .title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .collateral-dynamic .borrowing-base-card .kpi-label{
      font-size:12px;
      color:#475569;
      font-weight:600;
    }
    .collateral-dynamic .borrowing-base-card .kpi-value{
      font-size:26px;
      font-weight:800;
      color:#585858;
    }
    .collateral-dynamic .borrowing-base-card .kpi-delta{
      font-size:12px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .collateral-dynamic .borrowing-base-card .kpi-delta.up{color:var(--teal);}
    .collateral-dynamic .borrowing-base-card .kpi-delta.down{color:#e05555;}
    .collateral-dynamic .borrowing-base-card .borrowing-base-chart{
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      padding:8px;
    }
    .collateral-dynamic .ar-section .kpi .mini{
      border-top:1px solid rgba(226,232,248,.7);
      padding-top:6px;
    }
    .collateral-dynamic .ar-section .two-col,
    .collateral-dynamic .ar-section .three-col,
    .collateral-dynamic .ar-section .tables-row{
      display:grid;
      gap:14px;
    }
.collateral-dynamic .ar-section .two-col{
  grid-template-columns:minmax(280px,0.85fr) minmax(380px,1.15fr);
}
    .collateral-dynamic .ar-section .aging-charts{
      grid-template-columns:minmax(300px,0.8fr) minmax(520px,1.4fr);
      align-items:stretch;
      column-gap:25px;
    }
    .collateral-dynamic .ar-section .aging-charts .subcard{
      height:100%;
      border-radius:12px;
      box-shadow:var(--cd-shadow);
      padding:12px 14px 14px;
    }
    @media (max-width: 980px){
      .collateral-dynamic .ar-section .aging-charts{
        grid-template-columns:1fr;
      }
    }

    .collateral-dynamic .ar-section .tables-row{
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      margin-top:14px;
    }
    .collateral-dynamic .ar-section .three-col{
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    }
    .collateral-dynamic .ar-section .subcard{
      border:1px solid #e2e8f8;
      border-radius:14px;
      padding:20px;
      background:#fff;
    }
    .collateral-dynamic .ar-section .ineligible-detail .two-col{
      grid-template-columns:minmax(240px,.85fr) minmax(320px,1.15fr);
      align-items:stretch;
    }
    @media (max-width: 980px){
      .collateral-dynamic .ar-section .ineligible-detail .two-col{
        grid-template-columns:1fr;
      }
    }
    .collateral-dynamic .ar-section .subhead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      gap:12px;
    }
    .collateral-dynamic .ar-section .ineligible-overview .chart-wrap,
    .collateral-dynamic .ar-section .ineligible-trend .chart-wrap{
      background:transparent;
      border:0;
      border-radius:0;
      padding:0;
      height:auto;
    }
    .collateral-dynamic .aging-composition-chart{
      --aging-grid:#edf2f7;
      --aging-axis:#9aa7b8;
      --aging-label:#6b7280;
      --aging-percent:#6b7280;
      --chart-width:480;
      --chart-height:240;
      --axis-left:40;
      --axis-right:460;
      --axis-top:20;
      --axis-bottom:160;
      --axis-color:var(--aging-grid);
      position:relative;
      width:95%;
      aspect-ratio:var(--chart-width) / var(--chart-height);
      max-width:100%;
      margin:0 auto;
    }
    .collateral-dynamic .aging-composition-chart .chart-axis-label{
      color:var(--aging-axis);
      font-size:10pt;
      pointer-events:none;
    }
    .collateral-dynamic .aging-composition-chart .aging-percent{
      position:absolute;
      font-size:10px;
      color:var(--aging-percent);
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      transform:translate(-50%, -50%);
      white-space:nowrap;
      pointer-events:none;
    }
    .collateral-dynamic .aging-composition-chart .aging-label{
      position:absolute;
      margin-top: 10px;
      font-size:10pt;
      color:var(--aging-label);
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      transform:translate(-50%, -50%);
      white-space:nowrap;
    }
    .collateral-dynamic .aging-composition-chart .aging-label.secondary{
      margin-top:18px;
    }
    .collateral-dynamic .aging-composition-chart .aging-bar{
      position:absolute;
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      width:calc(var(--bar-width) * 100% / var(--chart-width));
      height:calc(var(--bar-height) * 100% / var(--chart-height));
      background:var(--bar-color, #1b2a55);
      border-radius:3px;
    }
    .collateral-dynamic .ar-trend-chart{
      --chart-width:520;
      --chart-height:190;
      --axis-left:40;
      --axis-right:500;
      --axis-top:20;
      --axis-bottom:140;
    }
    /* Keep AR trend x-axis labels centered under their bars */
    .collateral-dynamic .ar-trend-chart .label-layer{
      margin-left:0;
    }
    .collateral-dynamic .trend-bar{
      position:absolute;
      left:calc(var(--x) * 100% / var(--chart-width));
      top:calc(var(--y) * 100% / var(--chart-height));
      width:calc(var(--bar-width) * 100% / var(--chart-width));
      height:calc(var(--bar-height) * 100% / var(--chart-height));
      border-radius:4px;
    }
    .collateral-dynamic .trend-bar.past{background:#1b2a55;}
    .collateral-dynamic .trend-bar.current{background:#6d82ff;}
    .collateral-dynamic .ar-ineligible-chart{
      --chart-width:520;
      --chart-height:260;
      --axis-left:60;
      --axis-right:500;
      --axis-top:40;
      --axis-bottom:220;
    }
    .collateral-dynamic .ineligible-trend-card{
      display:flex;
      flex-direction:column;
    }
    .collateral-dynamic .ineligible-trend-card .ar-graph{
      flex:1;
      display:flex;
    }
    .collateral-dynamic .ineligible-trend-card .ar-graph .chart-box{
      width:100%;
      height:100%;
      aspect-ratio:auto;
    }
    .collateral-dynamic .chart-axis-title{
      position:absolute;
      right:4px;
      top:calc(90 * 100% / var(--chart-height));
      transform:rotate(90deg);
      transform-origin:right top;
      font-size:12px;
      color:rgba(15,23,42,.55);
      white-space:nowrap;
      pointer-events:none;
    }
    .collateral-dynamic .ar-ineligible-chart .chart-axis-title{
      right:auto;
      left: -10px;
      transform:rotate(-90deg);
      transform-origin:left top;
          margin-top: 127px;
    }
    .collateral-dynamic .ar-section .h3{
      font-size:20px;
      font-weight:700;
      margin:15px;
      display:flex;
      align-items:center;
      gap:6px;
      color:#585858;
    }
    .collateral-dynamic .ar-section .pct-label{
      font-size:14px;
      color:rgba(15,23,42,.6);
    }
    .collateral-dynamic .ar-section .legend{
      font-size:14px;
      color:rgba(15,23,42,.65);
      display:flex;
      gap:12px;
    }
    .collateral-dynamic .ar-section .swatch{
      width:10px;
      height:10px;
      border-radius:3px;
      display:inline-block;
      margin-right:6px;
    }
    .no-border{border: none,!important;}
    .collateral-dynamic .ar-section .swatch.past{background:#1b2a55;}
    .collateral-dynamic .ar-section .swatch.current{background:var(--blue-2);}
    .collateral-dynamic .ar-section .swatch.current{background:#6d82ff;}
    .collateral-dynamic .ar-section table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:11px;
      color:#475569;
    }
    .collateral-dynamic .ar-section .aging-table{
      font-size:12px;
    }
    .collateral-dynamic .ar-section .aging-table col.col-customer{
      width:28%;
    }
    .collateral-dynamic .ar-section .aging-table col.col-age{
      width:11%;
    }
    .collateral-dynamic .ar-section .aging-table col.col-total{
      width:9%;
    }
    .collateral-dynamic .ar-section .aging-table col.col-percent{
      width:9%;
    }
    .collateral-dynamic .ar-section .aging-table thead th,
    .collateral-dynamic .ar-section .aging-table tbody td{
      padding:8px 12px;
    }
    .collateral-dynamic .ar-section .aging-table thead th:not(:first-child),
    .collateral-dynamic .ar-section .aging-table tbody td:not(:first-child){
      text-align:center;
    }
    .collateral-dynamic .ar-section .ineligible-table{
      font-size:12px;
    }
    .collateral-dynamic .ar-section .ineligible-table thead th,
    .collateral-dynamic .ar-section .ineligible-table tbody td{
      padding:8px 12px;
    }
    .collateral-dynamic .ar-section .ineligible-table tfoot tr,
    .collateral-dynamic .ar-section .ineligible-table tbody tr.total {
      background:#f7faff;
    }
    .collateral-dynamic .ar-section .aging-table .align-right{
      text-align:center;
      font-size:12px;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }
    .collateral-dynamic .ar-section thead th{
      text-align:left;
      padding:6px 8px;
      font-weight:700;
      font-size:10pt;
      color:#6b7280;
      background:#f7faff;
      border-top:1px solid #e3eaf7;
      border-bottom:1px solid #e3eaf7;
    }
    .collateral-dynamic .ar-section thead th:first-child{
      font-size: 10pt;
      border-left:1px solid #e3eaf7;
      border-top-left-radius:8px;
    }
    .collateral-dynamic .ar-section thead th:last-child{
      border-right:1px solid #e3eaf7;
      border-top-right-radius:8px;
    }
    .collateral-dynamic .ar-section tbody td{
      padding:6px 8px;
      border-bottom:1px solid #eef2fb;
      background:#fff;
    }
    .collateral-dynamic .ar-section tbody tr:last-child td{
      border-bottom:1px solid #e3eaf7;
    }
    .collateral-dynamic .ar-section .ineligible-table tbody tr:last-child td{
      border-bottom:1px solid #e3eaf7;
      background:#f7faff;
    }
    .collateral-dynamic .ar-section .table-title{
      font-size:14px;
      font-weight:700;
      color:#111827;
      margin-bottom:10px;
    }
    .collateral-dynamic .ar-section .tables-row{
      border:1px solid #e6edf7;
      border-radius:12px;
      background:#fff;
      overflow:hidden;
      gap:0;
      padding:0;
      position:relative;
    }
    .collateral-dynamic .ar-section .tables-row::after{
      content:"";
      position:absolute;
      top:16px;
      bottom:16px;
      left:50%;
      width:1px;
      background:#e6edf7;
      transform:translateX(-0.5px);
      pointer-events:none;
    }
    .collateral-dynamic .ar-section .tables-row .subcard{
      border:0;
      border-radius:0;
      padding:12px 14px;
      background:transparent;
    }
    .collateral-dynamic .ar-section .tables-row .table-title{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      font-size:14px;
      font-weight:700;
      color:#1f2b5b;
      margin-bottom:12px;
    }
    .collateral-dynamic .ar-section .tables-row .table-title::before,
    .collateral-dynamic .ar-section .tables-row .table-title::after{
      content:"";
      flex:1;
      height:1px;
      background:#e4eaf4;
    }
    .collateral-dynamic .ar-section .tables-row table{
      border-collapse:collapse;
      width:100%;
      font-size:11px;
      color:#475569;
    }
    .collateral-dynamic .ar-section .tables-row thead th{
      background:#f7f9fc;
      color:#64748b;
      font-weight:600;
      font-size:12px;
      padding:8px 10px;
      border-bottom:1px solid #e7edf6;
      border-top:1px solid #e7edf6;
      text-align:center;
    }
    .collateral-dynamic .ar-section .tables-row thead th:first-child{
      text-align:left;
      border-left:1px solid #e7edf6;
      font-size: 10pt;
    }
    .collateral-dynamic .ar-section .tables-row thead th:last-child{
      border-right:1px solid #e7edf6;
    }
    .collateral-dynamic .ar-section .tables-row tbody td{
      padding:8px 10px;
      border-bottom:1px solid #eef2f7;
      text-align:center;
    }
    .collateral-dynamic .ar-section .tables-row tbody td:first-child{
      text-align:left;
    
    }
    .collateral-dynamic .ar-section .aging-scroll{
      width:100%;
      overflow-x:auto;
    }
    .collateral-dynamic .ar-section .aging-scroll table{
      min-width:720px;
    }
    .collateral-dynamic .ar-section .align-right{text-align:right;}
    .collateral-dynamic .ar-section .align-center{text-align:center;}
    .collateral-dynamic .ar-section .centered-table th,
    .collateral-dynamic .ar-section .centered-table td{
      text-align:center;
    }
    .collateral-dynamic .ar-section .centered-table{
      font-size:12px;
    }
    .collateral-dynamic .ar-section .centered-table thead th,
    .collateral-dynamic .ar-section .centered-table tbody td{
      padding:9px 12px;
    }
    .collateral-dynamic .ar-section .centered-table th:first-child,
    .collateral-dynamic .ar-section .centered-table td:first-child{
      text-align:left;
      font-size: 10pt;
    }
    .collateral-dynamic .ar-section .comparison-blocks{
      gap:0;
    }
    .collateral-dynamic .ar-section .comparison-blocks .subcard{
      border:0;
      border-radius:0;
      padding:0 18px;
    }
    .collateral-dynamic .ar-section .comparison-blocks .subcard + .subcard{
      border-left:1px solid #e2e8f8;
    }
    .collateral-dynamic .ar-section .comparison-blocks .centered-title{
      text-align:center;
      font-weight:700;
      color:#1f2b5b;
      margin-bottom:8px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .collateral-dynamic .ar-section .comparison-blocks .centered-title::before,
    .collateral-dynamic .ar-section .comparison-blocks .centered-title::after{
      content:"";
      flex:1;
      height:1px;
      background:#e2e8f8;
    }
    .collateral-dynamic .ar-section .total td{
      font-weight:800;
    }
    .collateral-dynamic .borrowing-base{
      border:1px solid rgba(0,122,245,.1);
      box-shadow:0px 1px 2px rgba(0,0,0,.05);
      border-radius:12px;
      padding:18px 20px 20px;
      background:#fff;
    }
    .collateral-dynamic .borrowing-base .h2{
      font-family:'Roboto',sans-serif;
      font-weight:600;
      font-size:24px;
      line-height:24px;
      letter-spacing:-0.6px;
      color:#585858;
      align-items:center;
      gap:8px;
    }
    .collateral-dynamic .borrowing-base .kpis{
      margin-top:16px;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }
    .collateral-dynamic .borrowing-base .kpi{
      flex:1;
      min-width:200px;
      border:1px solid rgba(15,23,42,.08);
      box-shadow:0px 4px 12px rgba(15,23,42,.08);
      border-radius:12px;
      padding:18px;
      background:#fff;
    }
    .collateral-dynamic .borrowing-base .kpi .label{
      font-size:11px;
      color:#6b7280;
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .collateral-dynamic .borrowing-base .kpi .value{
      font-size:26px;
      font-weight:700;
      margin-top:6px;
      color:#111827;
    }
    .collateral-dynamic .borrowing-base .kpi .delta{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:600;
      font-size:12px;
    }
    .collateral-dynamic .borrowing-base .kpi .delta span{
      display:inline-flex;
      align-items:center;
    }
.chart-wrap.ar-chart{
  width: 100%;
  max-width: 100%;
  margin-top: 18px;
  padding-bottom: 18px;
}
.content-inner{
  margin-top: -45px;
}
/* 
.chart-wrap.ar-chart svg{
    width: 66%;
    height: 111%;   
    margin-top: -28px;
} */

.tables-row{
      border:1px solid #e6edf7;
      border-radius:12px;
}
.side-line{after {
    content: "";
    flex: 1;
    height: 1px;
    background: #e4eaf4;
}}
.chart-layer-bar {
position: absolute;
inset: 0;
z-index: 3;
width: 91%;
height: 102%;
}
  </style>
{% endblock %}

{% block page_content %}
  <div class="collateral-dynamic">
    <div class="layout">
      {% include "collateral_dynamic/inventory/_menu.html" with inventory_tab=inventory_tab|default:"summary" active_section=active_section %}
      <div class="page">
        {% if active_section == 'overview' %}
          <div class="panel placeholder-panel">
            <div class="panel-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3h18v18H3z"/>
                <path d="M3 9h18"/>
                <path d="M9 21V9"/>
              </svg>
              Overview
            </div>            
          </div>
        {% elif active_section == 'accounts_receivable' %}
          <div class="ar-section">
            <main class="content">
              <div class="content-inner">
                <form class="filters" method="get">
                  <input type="hidden" name="section" value="accounts_receivable">
                  <label class="select">
                    <select name="ar_range" aria-label="Date range" onchange="this.form.submit()">
                      {% for option in ar_range_options %}
                        <option value="{{ option.value }}" {% if option.value == ar_selected_range %}selected{% endif %}>
                          {{ option.label }}
                        </option>
                      {% endfor %}
                    </select>
                    <span class="caret" aria-hidden="true">
                      <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
                    </span>
                  </label>
                  <label class="select">
                    <select name="ar_division" aria-label="Division filter" onchange="this.form.submit()">
                      {% for option in ar_division_options %}
                        <option value="{{ option.value }}" {% if option.value == ar_selected_division %}selected{% endif %}>
                          {{ option.label }}
                        </option>
                      {% endfor %}
                    </select>
                    <span class="caret" aria-hidden="true">
                      <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"></path></svg>
                    </span>
                  </label>
                </form>

                <!-- Snapshot Summary -->
                <section class="card ineligible-detail">
                  <div class="h2">
                    <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                    Snapshot Summary
                  </div>
                  <p class="p">
                    {{ accounts_receivable_snapshot_summary|linebreaksbr }}
                  </p>
                </section>

                <!-- Borrowing Base Insight -->
                <section class="card">
                  <div class="h2">
                    <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                    Borrowing Base Insight
                  </div>

                  <div class="borrowing-base-insight">
                    {% for kpi in ar_borrowing_base_kpis %}
                      {% cycle "#0b5bd3" "#8b3aa8" "#1aa37a" as line_color silent %}
                      <div class="borrowing-base-column">
                        <div class="borrowing-base-kpi">
                          <div class="kpi-top">
                            <div>
                              <div class="kpi-label">{{ kpi.label }}</div>
                              <div class="kpi-value">{{ kpi.value }}</div>
                              {% if kpi.delta %}
                                <div class="kpi-delta {{ kpi.delta_class }}">
                                  {{ kpi.symbol }} <span>{{ kpi.delta }}</span>
                                </div>
                              {% endif %}
                            </div>
                              <img src="{% static kpi.icon|default:'images/balance.svg' %}" alt="{{ kpi.label }} icon" />
                            
                          </div>
                          <div class="kpi-tooltip" aria-hidden="true">
                            <strong>{{ kpi.label }}</strong>
                            <span>{{ kpi.value }}</span>
                            {% if kpi.delta %}
                              <span>{{ kpi.symbol }} {{ kpi.delta }}</span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="borrowing-base-chart chart-wrap ar-chart">
                          <div class="chart-box bb-chart"
                            style="--chart-width:260; --chart-height:140; --axis-left:{{ kpi.chart.grid.left }}; --axis-right:{{ kpi.chart.grid.right }}; --axis-top:{{ kpi.chart.grid.top }}; --axis-bottom:{{ kpi.chart.grid.bottom }};">
                            <div class="chart-layer line-layer"
                              data-chart-width="260"
                              data-chart-height="140"
                              data-line-color="{{ line_color }}"
                              data-line-source="dots"
                              data-line-points="{{ kpi.chart.points }}"
                              aria-hidden="true"></div>
                            <div class="chart-layer is-static">
                              {% for tick in kpi.chart.y_ticks %}
                                <span class="chart-grid-line h" style="--y: {{ tick.y }}"></span>
                              {% endfor %}
                              {% for x in kpi.chart.x_grid %}
                                <span class="chart-grid-line v" style="--x: {{ x }}"></span>
                              {% endfor %}
                            </div>
                            <div class="chart-layer-bar is-static label-layer">
                              {% for tick in kpi.chart.y_ticks %}
                                <span class="chart-axis-label y end" style="--x: {{ kpi.chart.label_x }}; --y: {{ tick.y }}">{{ tick.label }}</span>
                              {% endfor %}
                              {% for label in kpi.chart.x_labels %}
                                <span class="chart-axis-label x" style="--x: {{ label.x }}; --y: {{ kpi.chart.label_y }}">{{ label.text }}</span>
                              {% endfor %}
                            </div>
                            <div class="chart-layer-bar">
                              {% for dot in kpi.chart.dots %}
                                <span class="chart-dot" style="--x: {{ dot.cx }}; --y: {{ dot.cy }}; --dot-color: {{ line_color }};"></span>
                                <span class="chart-hit ar-tip"
                                  style="--x: {{ dot.cx }}; --y: {{ dot.cy }};"
                                  data-label="{{ dot.label }}"
                                  data-series="{{ kpi.label }}"
                                  data-value="{{ dot.value }}"></span>
                              {% endfor %}
                            </div>
                          </div>
                          <div class="chart-tooltip" aria-hidden="true"></div>
                        </div>
                      </div>
                    {% empty %}
                      <div class="borrowing-base-column">
                        <div class="borrowing-base-kpi">
                          <div class="kpi-top">
                            <div>
                              <div class="kpi-label">Balance</div>
                              <div class="kpi-value">—</div>
                              <div class="kpi-delta">—</div>
                            </div>
                              <img src="{% static 'images/balance.svg' %}" alt="Balance icon" />
                            
                          </div>
                        </div>
                        <div class="borrowing-base-chart chart-wrap">
                          <div class="chart-box bb-chart"
                            style="--chart-width:260; --chart-height:140; --axis-left:20; --axis-right:240; --axis-top:20; --axis-bottom:120;">
                            <div class="chart-layer line-layer"
                              data-chart-width="260"
                              data-chart-height="140"
                              data-line-source="dots"
                              aria-hidden="true"></div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </section>

                <!-- Aging Analysis -->
                <section class="card">
                  <div class="h2">
                    <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                    Aging Analysis
                  </div>

                  <div class="two-col aging-charts">
                    <!-- Aging Composition -->
                    <div class="subcard ineligible-overview">
                      <div class="subhead">
                        <div class="h3">
                          <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                          Aging Composition
                        </div>
                        <div style="font-size:14px;color:rgba(15,23,42,.45)">%</div>
                      </div>

                      <div class="chart-wrap ar-chart">
                        <div class="chart-box aging-composition-chart" aria-label="Aging composition bar chart">
                          <div class="chart-layer is-static" style="height: 400px;">
                            <span class="chart-grid-line v axis-line" style="--x: 40"></span>
                            <span class="chart-grid-line h axis-line" style="--y: 160"></span>
                            <span class="chart-grid-line h" style="--y: 125"></span>
                            <span class="chart-grid-line h" style="--y: 90"></span>
                            <span class="chart-grid-line h" style="--y: 55"></span>
                            <span class="chart-grid-line h" style="--y: 20"></span>
                          </div>
                          <div class="chart-layer is-static label-layer" style="height: 400px;" >
                            <span class="chart-axis-label y" style="--x: 10; --y: 143">$20</span>
                            <span class="chart-axis-label y" style="--x: 10; --y: 113">$40</span>
                            <span class="chart-axis-label y" style="--x: 10; --y: 83">$60</span>
                            <span class="chart-axis-label y" style="--x: 10; --y: 53">$80</span>
                          </div>
                          <div class="chart-layer-bar" style="height: 400px;">
                            {% for bucket in ar_aging_chart_buckets %}
                              <div class="aging-bar ar-tip"
                                style="--x: {{ bucket.x }}; --y: {{ bucket.y }}; --bar-width: {{ bucket.width }}; --bar-height: {{ bucket.height }}; --bar-color: {{ bucket.color }};"
                                data-label="{{ bucket.label }}"
                                data-value="{{ bucket.percent_display }}"
                                data-extra="{{ bucket.amount_display }}"></div>
                              <span class="aging-percent" style="--x: {{ bucket.text_x }}; --y: {{ bucket.percent_y }}">{{ bucket.percent_display }}</span>
                              <span class="aging-label" style="--x: {{ bucket.text_x }}; --y: {{ bucket.label_y }}">{{ bucket.label_primary }}</span>
                              {% if bucket.label_secondary %}
                                <span class="aging-label secondary" style="--x: {{ bucket.text_x }}; --y: {{ bucket.label_secondary_y }}">{{ bucket.label_secondary }}</span>
                              {% endif %}
                            {% empty %}
                              <span class="chart-empty">No aging data</span>
                            {% endfor %}
                          </div>
                        </div>
                        <div class="chart-tooltip" aria-hidden="true"></div>
                      </div>
                    </div>

                    <!-- Current vs Past Due Trend -->
                    <div class="subcard ineligible-trend">
                      <div class="subhead">
                        <div class="h3">
                          <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                          Current vs Past Due Trend
                        </div>
                        <div class="legend">
                          <span><i class="swatch past"></i>Past Due</span>
                          <span><i class="swatch current"></i>Current</span>
                        </div>
                      </div>

                      <div class="chart-wrap ar-chart ar-trend-chart">
                        <div class="chart-box" aria-label="Current vs Past Due stacked bar chart">
                          <div class="chart-layer is-static">
                            {% for tick in ar_current_vs_past_due_trend.ticks %}
                              <span class="chart-grid-line h" style="--y: {{ tick.y|floatformat:1 }}"></span>
                            {% endfor %}
                            <span class="chart-grid-line h axis-line" style="--y: 140"></span>
                          </div>
                          <div class="chart-layer is-static label-layer">
                            {% for tick in ar_current_vs_past_due_trend.ticks %}
                              <span class="chart-axis-label y" style="--x: 10; --y: {{ tick.y|add:'3'|floatformat:1 }}">{{ tick.label }}</span>
                            {% endfor %}
                            {% for label in ar_current_vs_past_due_trend.labels %}
                              <span class="chart-axis-label x stack center" style="--x: {{ label.x }}; --y: 176">
                                <span>{{ label.month }}</span>
                                {% if label.year %}
                                  <span>{{ label.year }}</span>
                                {% endif %}
                              </span>
                            {% endfor %}
                          </div>
                          <div class="chart-layer">
                            {% if ar_current_vs_past_due_trend.bars %}
                              {% for bar in ar_current_vs_past_due_trend.bars %}
                                <div class="trend-bar past ar-tip"
                                  style="--x: {{ bar.x }}; --y: {{ bar.past_due_y }}; --bar-width: {{ bar.width }}; --bar-height: {{ bar.past_due_height }};"
                                  data-label="{{ bar.label }}"
                                  data-series="Past Due"
                                  data-value="{{ bar.past_due_value }}"></div>
                                <div class="trend-bar current ar-tip"
                                  style="--x: {{ bar.x }}; --y: {{ bar.current_y }}; --bar-width: {{ bar.width }}; --bar-height: {{ bar.current_height }};"
                                  data-label="{{ bar.label }}"
                                  data-series="Current"
                                  data-value="{{ bar.current_value }}"></div>
                              {% endfor %}
                            {% else %}
                              <span class="chart-empty">No trend data</span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="chart-tooltip" aria-hidden="true"></div>
                      </div>
                    </div>
                  </div>

                  <div class="tables-row">
                    <div class="subcard no-border side-line">
                      
                      <div class="table-title">Customer Aging Composition by Total Balance</div>
                      <div class="aging-scroll">
                        <table class="aging-table">
                          <colgroup>
                            <col class="col-customer" />
                            <col class="col-age" span="5" />
                            <col class="col-total" />
                            <col class="col-percent" />
                          </colgroup>
                          <thead>
                            <tr>
                              <th>Customer</th>
                              <th>Current</th>
                              <th>0-30</th>
                              <th>31-60</th>
                              <th>61-90</th>
                              <th>91+</th>
                              <th>Total</th>
                              <th>% of Total</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for row in ar_customer_aging_total_rows %}
                              <tr>
                                <td>{{ row.customer }}</td>
                                {% for value in row.values %}
                                  <td class="align-right">{{ value }}</td>
                                {% endfor %}
                                <td class="align-right">{{ row.total }}</td>
                                <td class="align-right">{{ row.percent_total }}</td>
                              </tr>
                            {% empty %}
                              <tr>
                                <td colspan="8" class="align-center">No aging composition data</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <div class="subcard no-border"> 
                      <div class="table-title">Customer Aging Composition by Past Due Balance</div>
                      <div class="aging-scroll">
                        <table class="aging-table">
                          <colgroup>
                            <col class="col-customer" />
                            <col class="col-age" span="5" />
                            <col class="col-total" />
                            <col class="col-percent" />
                          </colgroup>
                          <thead>
                            <tr>
                              <th>Customer</th>
                              <th>Current</th>
                              <th>0-30</th>
                              <th>31-60</th>
                              <th>61-90</th>
                              <th>91+</th>
                              <th>Total</th>
                              <th>% of Total</th>
                            </tr>
                          </thead>
                            <tbody>
                            {% for row in ar_customer_aging_past_due_rows %}
                              <tr>
                                <td>{{ row.customer }}</td>
                                {% for value in row.values %}
                                  <td class="align-right">{{ value }}</td>
                                {% endfor %}
                                <td class="align-right">{{ row.total }}</td>
                                <td class="align-right">{{ row.percent_total }}</td>
                              </tr>
                            {% empty %}
                              <tr>
                                <td colspan="8" class="align-center">No aging composition data</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Ineligible Detail -->
                <section class="card">
                  <div class="h2">
                    <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                    Ineligible Detail
                  </div>

                  <div class="two-col">
                    <div class="subcard IO">
                      <div class="h3" style="margin-bottom:8px">
                        <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                        Ineligible Overview
                      </div>

                      <table class="ineligible-table">
                        <thead>
                          <tr>
                            <th>Ineligibles</th>
                            <th style="text-align:center">Amount</th>
                            <th style="text-align:center">% Of Total</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in ar_ineligible_overview_rows %}
                            <tr>
                              <td>{{ row.label }}</td>
                              <td class="align-center">{{ row.amount }}</td>
                              <td class="align-center">{{ row.pct }}</td>
                            </tr>
                          {% empty %}
                            <tr>
                              <td colspan="3" class="align-center">No ineligible overview data</td>
                            </tr>
                          {% endfor %}
                          {% if ar_ineligible_overview_total %}
                            <tr class="total-IO">
                              <td>{{ ar_ineligible_overview_total.label }}</td>
                              <td class="align-center">{{ ar_ineligible_overview_total.amount }}</td>
                              <td class="align-center">{{ ar_ineligible_overview_total.pct }}</td>
                            </tr>
                          {% endif %}
                        </tbody>
                      </table>
                    </div>

                    <div class="subcard ineligible-trend-card">
                      <div class="subhead">
                        <div class="h3">
                          <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                          Ineligible Accounts Receivable Trend
                        </div>
                      </div>

                      <div class="ar-graph chart-wrap ar-chart">
                        <div class="chart-box ar-ineligible-chart" aria-label="Ineligible AR trend line chart">
                          <div class="chart-layer line-layer"
                            data-chart-width="520"
                            data-chart-height="260"
                            data-line-color="#0b5bd3"
                            data-line-source="dot-layout"
                            data-line-points="{{ ar_ineligible_trend.points }}"
                            aria-hidden="true"></div>
                          <div class="chart-layer is-static">
                            <span class="chart-grid-line v axis-line" style="--x: 60"></span>
                            {% for tick in ar_ineligible_trend.ticks %}
                              <span class="chart-grid-line h {% if forloop.last %}axis-line{% endif %}" style="--y: {{ tick.y|floatformat:1 }}"></span>
                            {% endfor %}
                          </div>
                          <div class="chart-layer is-static label-layer">
                            {% for tick in ar_ineligible_trend.ticks %}
                              <span class="chart-axis-label y" style="--x: 28; --y: {{ tick.y|add:'4'|floatformat:1 }}">{{ tick.label }}</span>
                            {% endfor %}
                          </div>
                          <div class="chart-layer">
                            {% if ar_ineligible_trend.points %}
                              {% for dot in ar_ineligible_trend.dots %}
                                <span class="chart-dot" style="--x: {{ dot.cx }}; --y: {{ dot.cy }}; --dot-color: #0b5bd3;"></span>
                                <span class="chart-hit ar-tip"
                                  style="--x: {{ dot.cx }}; --y: {{ dot.cy }};"
                                  data-label="{{ dot.label }}"
                                  data-value="{{ dot.value }}"></span>
                              {% endfor %}
                              {% for label in ar_ineligible_trend.labels %}
                                <span class="chart-axis-label x start stack" style="--x: {{ label.x }}; --y: 234">
                                  <span>{{ label.month }}</span>
                                  {% if label.year %}
                                    <span class="chart-axis-year">{{ label.year }}</span>
                                  {% endif %}
                                </span>
                              {% endfor %}
                            {% else %}
                              <span class="chart-empty">No ineligible trend data</span>
                            {% endif %}
                            <span class="chart-axis-title">% of Accounts Receivable</span>
                          </div>
                        </div>
                        <div class="chart-tooltip" aria-hidden="true"></div>
                      </div>

                    </div>
                  </div>
                </section>

                <!-- Customer Exposure & Collection Trend -->
                <section class="card">
                  <div class="h2">
                    <img src="{% static 'images/borrowing_icon.svg' %}" 
          alt="Current Update Icon"
          class="current-update-icon" />
                    Customer Exposure &amp; Collection Trend
                  </div>

                  <div class="three-col comparison-blocks">
                    <div class="subcard">
                      <div class="table-title centered-title">
                        <span>Concentration</span>
                        <span class="table-pill">%</span>
                      </div>
                     <table class="centered-table">
                        <thead>
                          <tr>
                            <th>Customer</th>
                            <th style="text-align:center">Current</th>
                            <th style="text-align:center">Average TTM</th>
                            <th style="text-align:center">Variance</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in ar_concentration_rows %}
                            <tr>
                              <td>{{ row.customer }}</td>
                              <td class="align-center">{{ row.current }}</td>
                              <td class="align-center">{{ row.average }}</td>
                              <td class="align-center">{{ row.variance }}</td>
                            </tr>
                          {% empty %}
                            <tr>
                              <td colspan="4" class="align-center">No concentration data</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>

                    <div class="subcard">
                      <div class="table-title centered-title">
                        <span>Average Days Outstanding</span>
                        <span class="table-pill">Days</span>
                      </div>
                      <table class="centered-table">
                        <thead>
                          <tr>
                            <th style="text-align:center">Customer</th>
                            <th style="text-align:center">Current</th>
                            <th style="text-align:center">Average TTM</th>
                            <th style="text-align:center">Variance</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in ar_ado_rows %}
                            <tr>
                              <td class="align-left">{{ row.customer }}</td>
                              <td class="align-center">{{ row.current }}%</td>
                              <td class="align-center">{{ row.average }}%</td>
                              <td class="align-center">{{ row.variance }}</td>
                            </tr>
                          {% empty %}
                            <tr>
                              <td colspan="4" class="align-center">No ADO data</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>

                    <div class="subcard">
                      <div class="table-title centered-title">
                        <span>Days Sales Outstanding</span>
                        <span class="table-pill">Days</span>
                      </div>
                      <table class="centered-table">
                        <thead>
                          <tr>
                            <th style="text-align:center">Customer</th>
                            <th style="text-align:center">Current</th>
                            <th style="text-align:center">Average TTM</th>
                            <th style="text-align:center">Variance</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in ar_dso_rows %}
                            <tr>
                              <td class="align-left">{{ row.customer }}</td>
                              <td class="align-center">{{ row.current }}%</td>
                              <td class="align-center">{{ row.average }}%</td>
                              <td class="align-center">{{ row.variance }}</td>
                            </tr>
                          {% empty %}
                            <tr>
                              <td colspan="4" class="align-center">No DSO data</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>

              </div>
            </main>
          </div>
        {% else %}
          {% if inventory_tab == 'finished_goods' %}
            {% include "collateral_dynamic/inventory/finished_goals.html" %}
          {% elif inventory_tab == 'raw_materials' %}
            {% include "collateral_dynamic/inventory/raw_materials.html" %}
          {% elif inventory_tab == 'work_in_progress' %}
            {% include "collateral_dynamic/inventory/work_in_progress.html" %}
          {% elif inventory_tab == 'liquidation_model' %}
            {% include "collateral_dynamic/inventory/liquidation_model.html" %}
          {% elif inventory_tab == 'other_collateral' %}
            {% include "collateral_dynamic/inventory/other_collateral.html" %}
          {% else %}
            {% include "collateral_dynamic/inventory/summary.html" %}
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  {{ ar_ineligible_trend|json_script:"arIneligibleTrendData" }}
  <script>
(function(){
  function updateAgingCompositionMetrics(){
    var charts = document.querySelectorAll(".aging-composition-chart");
    if(!charts.length) return;
    charts.forEach(function(chart){
      var rect = chart.getBoundingClientRect();
      if(rect.width && rect.height){
        chart.style.setProperty("--chart-width", rect.width.toFixed(2));
        chart.style.setProperty("--chart-height", rect.height.toFixed(2));
      }
    });
  }
  window.addEventListener("resize", updateAgingCompositionMetrics);
  document.addEventListener("DOMContentLoaded", updateAgingCompositionMetrics);
  updateAgingCompositionMetrics();
})();

(function(){
      let arTrendLogged = false;
      function parseLinePoints(raw, baseWidth, baseHeight, actualWidth, actualHeight){
        if(!raw) return [];
        const safeBaseWidth = baseWidth || actualWidth || 1;
        const safeBaseHeight = baseHeight || actualHeight || 1;
        return raw.trim().split(/\s+/).map(pair=>{
          const parts = pair.split(",");
          const x = parseFloat(parts[0]);
          const y = parseFloat(parts[1]);
          if(Number.isNaN(x) || Number.isNaN(y)){
            return null;
          }
          return {
            x: (x / safeBaseWidth) * actualWidth,
            y: (y / safeBaseHeight) * actualHeight,
          };
        }).filter(Boolean);
      }
      function pointsFromDots(chartBox){
        if(!chartBox) return [];
        const dots = chartBox.querySelectorAll(".chart-dot");
        const boxRect = chartBox.getBoundingClientRect();
        return Array.from(dots).map(dot=>{
          const rect = dot.getBoundingClientRect();
          const x = (rect.left + rect.width / 2 - boxRect.left);
          const y = (rect.top + rect.height / 2 - boxRect.top);
          if(Number.isNaN(x) || Number.isNaN(y)){
            return null;
          }
          return {x,y};
        }).filter(Boolean);
      }
      function getBaseDimension(chartBox, layer, key){
        const datasetKey = `chart${key.charAt(0).toUpperCase()}${key.slice(1)}`;
        const datasetValue = layer.dataset[datasetKey] || chartBox.dataset[datasetKey];
        if(datasetValue) return parseFloat(datasetValue);
        const computed = getComputedStyle(chartBox).getPropertyValue(`--chart-${key}`);
        if(computed) return parseFloat(computed);
        return 0;
      }
      function renderLineSegments(layer, points, color){
        layer.innerHTML = "";
        if(color){
          layer.style.setProperty("--line-color", color);
        }
        for(let i = 0; i < points.length - 1; i++){
          const start = points[i];
          const end = points[i + 1];
          const dx = end.x - start.x;
          const dy = end.y - start.y;
          const length = Math.hypot(dx, dy);
          if(!length) continue;
          const angle = Math.atan2(dy, dx) * (180 / Math.PI);
          const segment = document.createElement("span");
          segment.className = "chart-line-segment";
          segment.style.width = `${length}px`;
          segment.style.left = `${start.x}px`;
          segment.style.top = `${start.y}px`;
          segment.style.transform = `translateY(-50%) rotate(${angle}deg)`;
          layer.appendChild(segment);
        }
      }
      let resizeObserver;
      let resizeScheduled = false;
      function observeChartResize(){
        if(resizeObserver || !("ResizeObserver" in window)) return;
        resizeObserver = new ResizeObserver(()=>{
          if(resizeScheduled) return;
          resizeScheduled = true;
          window.requestAnimationFrame(()=>{
            resizeScheduled = false;
            drawLineCharts();
          });
        });
        document.querySelectorAll(".chart-box").forEach(box=>{
          resizeObserver.observe(box);
        });
      }
      function drawLineCharts(){
        document.querySelectorAll(".chart-layer.line-layer").forEach(layer=>{
          const chartBox = layer.closest(".chart-box");
          if(!chartBox) return;
          const actualWidth = chartBox.clientWidth;
          const actualHeight = chartBox.clientHeight;
          if(!actualWidth || !actualHeight) return;
          const baseWidth = getBaseDimension(chartBox, layer, "width") || actualWidth;
          const baseHeight = getBaseDimension(chartBox, layer, "height") || actualHeight;
          let points = [];
          if(layer.dataset.lineSource === "dot-layout" || layer.dataset.lineSource === "dots"){
            points = pointsFromDots(chartBox);
          } else {
            points = parseLinePoints(layer.dataset.linePoints, baseWidth, baseHeight, actualWidth, actualHeight);
          }
          if(!points.length){
            layer.innerHTML = "";
            return;
          }
          renderLineSegments(layer, points, layer.dataset.lineColor || "#0b5bd3");
        });
      }
      function positionTooltip(wrap, event){
        const rect = wrap.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        return {x,y};
      }
      function attachArTooltips(){
        document.querySelectorAll(".ar-chart").forEach(chart=>{
          const tooltip = chart.querySelector(".chart-tooltip");
          if(!tooltip) return;
          const targets = chart.querySelectorAll(".ar-tip");
          const show = (event)=>{
            const target = event.currentTarget;
            const label = (target.dataset.label||"").replace(/\n/g," ");
            const series = target.dataset.series||"";
            const value = target.dataset.value||"";
            const extra = target.dataset.extra||"";
            const title = series ? `${label} • ${series}` : label;
            tooltip.innerHTML = `<strong>${value}</strong><span>${title}</span>${extra ? `<span>${extra}</span>` : ""}`;
            const {x,y} = positionTooltip(chart, event);
            tooltip.style.left = `${Math.max(12, Math.min(chart.clientWidth-12, x))}px`;
            tooltip.style.top = `${Math.max(18, Math.min(chart.clientHeight-12, y-12))}px`;
            tooltip.classList.add("is-visible");
          };
          const hide = ()=>tooltip.classList.remove("is-visible");
          targets.forEach(target=>{
            target.style.cursor = "pointer";
            target.addEventListener("mousemove", show);
            target.addEventListener("mouseenter", show);
            target.addEventListener("mouseleave", hide);
            target.addEventListener("blur", hide);
          });
        });
      }
      function logArIneligibleTrendData(){
        if(arTrendLogged) return;
        const dataEl = document.getElementById("arIneligibleTrendData");
        if(!dataEl) return;
        try{
          const data = JSON.parse(dataEl.textContent);
          console.info("[AR Ineligible Trend] series", {
            values: data.series_values || [],
            labels: data.series_labels || [],
            axisMin: data.axis_min,
            axisMax: data.axis_max,
            ticks: data.ticks || [],
          });
          arTrendLogged = true;
        } catch (error){
          console.warn("[AR Ineligible Trend] failed to parse chart data", error);
        }
      }
      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", ()=>{
          attachArTooltips();
          drawLineCharts();
          observeChartResize();
          logArIneligibleTrendData();
        });
      } else {
        attachArTooltips();
        drawLineCharts();
        observeChartResize();
        logArIneligibleTrendData();
        let resizeTimer;
        window.addEventListener("resize", ()=>{
          window.clearTimeout(resizeTimer);
          resizeTimer = window.setTimeout(drawLineCharts, 120);
        });
      }
    })();
  </script>
{% endblock %}
