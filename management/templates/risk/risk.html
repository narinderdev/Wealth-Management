{% extends "layout/app_base.html" %}

{% block title %}Risk Overview{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    .risk-page{
      --rk-line:#e6eef6;
      --rk-panel:#ffffff;
      --rk-muted:#6b7280;
      --rk-accent:#0b57d0;
      --rk-shadow:0 1px 0 rgba(17,24,39,.02), 0 8px 24px rgba(17,24,39,.06);
    }
    .risk-page .panel{
      background:var(--rk-panel);
      border:1px solid var(--rk-line);
      border-radius:8px;
      box-shadow:var(--rk-shadow);
      margin-bottom:14px;
    }
    .risk-page .section-h{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      font-weight:600;
      color:#1f2937;
      padding:10px 12px 6px;
    }
    .risk-page .panel:first-of-type .section-h{
      font-size:15px;
    }
    .risk-page .dot{
      width:8px;height:8px;border-radius:2px;
      background:#1d4ed8;
      box-shadow:0 0 0 2px #e7f0ff inset;
    }
    .risk-page .rating{
      padding:18px 16px 40px;
      position:relative;
    }
    .risk-page .rating-scale{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      color:#1f2937;
      font-weight:600;
      letter-spacing:.01em;
      margin-bottom:8px;
      padding:0 12px;
    }
    .risk-page .rating-bar{
      position:relative;
      margin-top:0;
      height:14px;
      border-radius:999px;
      background:#e6eef6;
      overflow:visible;
      box-shadow:inset 0 1px 2px rgba(15,23,42,.1);
    }
    .risk-page .rating-fill{
      position:absolute;
      inset:0;
      border-radius:999px;
      background:linear-gradient(90deg,#7ec459 0%,#d7c63c 25%,#fbb82e 50%,#fc8f2e 75%,#f74c34 100%);
    }
    .risk-page .rating-pin{
      position:absolute;
      top:50%;
      transform:translate(-50%,-50%);
      width:14px;
      height:14px;
      border-radius:50%;
      background:#fff;
      border:2px solid #1366d6;
      box-shadow:0 4px 8px rgba(15,23,42,.2);
      left:var(--risk-pos,50%);
    }
    .risk-page .rating-value{
      position:absolute;
      top:calc(100% + 6px);
      left:var(--risk-pos,50%);
      transform:translate(-50%,0);
      font-size:15px;
      color:#111827;
      font-weight:700;
      z-index:1;
      white-space:nowrap;
    }
    .risk-page .snapshot{
      padding:0 12px 12px;
      font-size:10px;
      color:#6b7280;
      line-height:1.4;
    }
    .risk-page .grid3{
      display:grid;
      grid-template-columns:1fr 1.2fr 1fr;
      gap:12px;
      padding:10px 12px 12px;
    }
    .risk-page .risk-stack{padding:8px 10px 10px;}
    .risk-page .donut-wrap{
      display:flex;
      gap:10px;
      align-items:center;
      padding:4px 0 10px;
    }
    .risk-page .donut{width:70px;height:70px;display:block;}
    .risk-page .donut text{font-size:6px;fill:#374151;font-weight:600;}
    .risk-page .pillcol{flex:1;display:flex;flex-direction:column;gap:6px;}
    .risk-page .pill{
      height:18px;
      border-radius:2px;
      display:flex;
      align-items:center;
      padding:0 8px;
      font-size:10px;
      font-weight:600;
      border:1px solid #d9e6f3;
    }
    .risk-page .pill.blue{background:#2d7ff0;color:#fff;border-color:#2d7ff0;}
    .risk-page .pill.navy{background:#0f4ea8;color:#fff;border-color:#0f4ea8;}
    .risk-page .pill.lt{background:#cfe4f7;color:#334;}
    .risk-page .pill.wt{background:#fff;color:#334;}
    .risk-page .chartbox{padding:8px 10px 10px;position:relative;}
    .risk-page .chart{
      width:100%;
      height:92px;
      border-top:1px solid #eef4fb;
      padding-top:8px;
    }
    .risk-page .axislabels{
      display:flex;
      justify-content:space-between;
      margin-top:6px;
      font-size:9px;
      color:#94a3b8;
    }
    .risk-page .y-axis-labels{
      position:absolute;
      left:8px;
      top:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size:10px;
      color:#94a3b8;
      pointer-events:none;
    }
    .risk-page table{
      width:100%;
      border-collapse:collapse;
      font-size:10px;
    }
    .risk-page th,
    .risk-page td{
      padding:7px 6px;
      border-bottom:1px solid #eef4fb;
      text-align:left;
      color:#374151;
      white-space:nowrap;
    }
    .risk-page th{
      color:#64748b;
      font-weight:600;
      font-size:9px;
    }
    .risk-page td:last-child,
    .risk-page th:last-child{text-align:right;}
    .risk-page .chg.up{color:#16a34a;font-weight:600;}
    .risk-page .chg.down{color:#dc2626;font-weight:600;}
    .risk-page .risk-metrics{
      padding:10px 12px 14px;
      background:linear-gradient(#ffffff,#ffffff) padding-box,
                 linear-gradient(180deg,#ffffff,#f7fbff) border-box;
    }
    .risk-page .divider{
      height:1px;
      background:var(--rk-line);
      margin:0 0 10px 0;
    }
    .risk-page .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:12px;
    }
    .risk-page .metric{
      --metric-donut:82px;
      --metric-gap:14px;
      --metric-label:156px;
      --metric-label-gap:14px;
      padding:18px 20px;
      border-radius:14px;
      background:#fff;
      border:1px solid #e4ecf7;
      box-shadow:0 12px 24px rgba(15, 23, 42, .08);
    }
    .risk-page .metric .top{
      padding-bottom:6px;
    }
    .risk-page .metric-title{
      font-size:13px;
      font-weight:600;
      color:#111827;
    }
    .risk-page .metric-body{
      display:grid;
      grid-template-columns:var(--metric-donut) 1fr;
      gap:var(--metric-gap);
      margin-top:6px;
      align-items:start;
    }
    .risk-page .metric-body .donut{
      display:block;
      margin-top:4px;
    }
    .risk-page .bars{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:26px 6px 4px 0;
    }
    .risk-page .bars > .scale{
      position:absolute;
      top:0;
      left:calc(var(--metric-label) + var(--metric-label-gap));
      right:0;
      display:flex;
      justify-content:space-between;
      gap:18px;
      font-size:10px;
      font-weight:600;
      color:#6b7280;
      letter-spacing:.02em;
    }
    .risk-page .barrow{
      display:grid;
      grid-template-columns:var(--metric-label) 1fr;
      gap:var(--metric-label-gap);
      align-items:center;
      position:relative;
    }
    .risk-page .bar-tooltip{
      position:absolute;
      top:-26px;
      left:var(--bar-left,50%);
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      color:#fff;
      padding:4px 8px;
      border-radius:4px;
      font-size:9px;
      white-space:nowrap;
      opacity:0;
      transition:opacity .2s ease;
      pointer-events:none;
    }
    .risk-page .barrow:hover .bar-tooltip{opacity:1;}
    .risk-page .risk-tooltip{
      position:absolute;
      background:rgba(15,23,39,.95);
      color:#fff;
      padding:5px 10px;
      border-radius:6px;
      font-size:11px;
      pointer-events:none;
      opacity:0;
      transition:opacity .2s ease;
      transform:translate(-50%, -110%);
      white-space:nowrap;
    }
    .risk-page .barrow .lbl{
      font-size:10px;
      color:#475467;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .risk-page .track{
      height:7px;
      background:#eaf0fb;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #dbe4f4;
    }
    .risk-page .fill{
      height:100%;
      background:linear-gradient(90deg,#1d4ed8,#1e40af);
      border-radius:999px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.3);
    }
    .risk-page .muted{color:var(--rk-muted);}
    @media (max-width:980px){
      .risk-page .grid3{grid-template-columns:1fr;}
      .risk-page .grid2{grid-template-columns:1fr;}
      .risk-page .barrow{grid-template-columns:150px 1fr;}
      .risk-page .metric{--metric-label:150px;}
    }
  </style>
{% endblock %}

{% block page_content %}
  <div class="risk-page">
    <section class="panel">
      <div class="section-h"><span class="dot"></span>Current Primary Risk Rating</div>
      <div class="rating">
        <div class="rating-scale">
          <span>Low</span><span>Mild</span><span>Average</span><span>Elevated</span><span>High</span>
        </div>
        <div class="rating-bar" aria-hidden="true" style="--risk-pos: {{ risk.rating_position }}%;">
          <div class="rating-fill"></div>
          <span class="rating-pin"></span>
          <span class="rating-value">{{ risk.rating_score }}</span>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="section-h"><span class="dot"></span>Snapshot Summary</div>
      <div class="snapshot">
        {{ risk.snapshot }}
      </div>
    </section>

    <section class="panel">
      <div class="grid3">
        <div class="panel" style="box-shadow:none;">
          <div class="section-h" style="padding-bottom:8px;"><span class="dot"></span>Composite Risk Index</div>
          <div class="risk-stack">
          <div class="donut-wrap">
            <svg class="donut" viewBox="0 0 42 42" aria-label="Composite risk donut">
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#cfe3f0" stroke-width="4"></circle>
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#0063f7" stroke-width="4"
                      stroke-linecap="round" stroke-dasharray="{{ risk.rating_dasharray }}" transform="rotate(-90 21 21)"></circle>
              <text x="21" y="22" text-anchor="middle">{{ risk.rating_score }}/5</text>
            </svg>
            <div class="pillcol">
              {% for pill in risk.pills %}
                <div class="pill {{ pill.class }}">{{ pill.value }} {{ pill.label|lower }}</div>
              {% endfor %}
            </div>
          </div>
          </div>
        </div>

        <div class="panel" style="box-shadow:none;">
          <div class="section-h" style="padding-bottom:8px;"><span class="dot"></span>Risk Index Trend</div>
          <div class="chartbox">
            <svg class="chart" viewBox="0 0 300 110" preserveAspectRatio="none" aria-label="Risk trend chart">
              <line x1="10" y1="20" x2="290" y2="20" stroke="#eef4fb" />
              <line x1="10" y1="55" x2="290" y2="55" stroke="#eef4fb" />
              <line x1="10" y1="90" x2="290" y2="90" stroke="#eef4fb" />
              <polyline fill="none" stroke="#0b57d0" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                points="{{ risk.trend_points }}" />
            <g fill="#0b57d0">
              {% for point in risk.trend_data %}
                <circle cx="{{ point.x }}" cy="{{ point.y }}" r="3.2"
                        data-label="{{ point.label }}" data-score="{{ point.score }}"></circle>
              {% endfor %}
            </g>
            </svg>
            <div class="y-axis-labels">
              <span>90%</span>
              <span>70%</span>
              <span>50%</span>
              <span>30%</span>
              <span>10%</span>
            </div>
            <div class="axislabels">
              {% for label in risk.trend_axis %}
                <span>{{ label }}</span>
              {% endfor %}
            </div>
            <div class="risk-tooltip" id="risk-tooltip"></div>
          </div>
        </div>

        <div class="panel" style="box-shadow:none;">
          <div class="section-h" style="padding-bottom:8px;"><span class="dot"></span>High Impact Factors</div>
          <div style="padding:0 10px 10px;">
            <table aria-label="High impact factors">
              <thead>
                <tr>
                  <th>Risk</th>
                  <th>Current Risk</th>
                  <th>Prior Risk</th>
                  <th style="text-align:right;">Change</th>
                </tr>
              </thead>
              <tbody>
                {% for factor in risk.high_impact %}
                  <tr>
                    <td>{{ factor.risk }}</td>
                    <td>{{ factor.current }}</td>
                    <td>{{ factor.prior }}</td>
                    <td class="{% if factor.direction %}chg {{ factor.direction }}{% endif %}">{{ factor.change }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="panel risk-metrics">
      <div class="section-h" style="padding:0 0 6px 0;"><span class="dot"></span>Risk Metrics</div>
      <div class="divider"></div>

      <div class="grid2">
        {% for metric in risk.metrics %}
          <div class="metric">
            <div class="top">
              <div class="metric-title">{{ metric.label }}</div>
            </div>
            <div class="metric-body">
              <svg class="donut" viewBox="0 0 42 42" aria-label="{{ metric.label }} score donut">
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="{{ metric.donut_bg }}" stroke-width="4"></circle>
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="{{ metric.donut_color }}" stroke-width="4"
                      stroke-linecap="round" stroke-dasharray="{{ metric.donut_dash }}" transform="rotate(-90 21 21)"></circle>
              <text x="21" y="22" text-anchor="middle">{{ metric.score_display }}</text>
            </svg>
            <div class="bars">
              <div class="scale"><span>Low</span><span>Mild</span><span>Moderate</span><span>Elevated</span><span>High</span></div>
              {% for bar in metric.bars %}
                <div class="barrow" style="--bar-left: {{ bar.width }};">
                  <div class="lbl">{{ bar.label }}</div>
                  <div class="track">
                    <div class="fill" style="width:{{ bar.width }}; background:{{ metric.fill_color }}"></div>
                  </div>
                  <span class="bar-tooltip">{{ bar.width }}</span>
                </div>
              {% endfor %}
            </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      const chartBox = document.querySelector(".risk-page .chartbox");
      const tooltip = document.getElementById("risk-tooltip");
      if(!chartBox || !tooltip) return;
      const svg = chartBox.querySelector("svg");
      const circles = svg.querySelectorAll("circle[data-score]");
      let activeCircle = null;
      const formatPercent = value => {
        const pct = Math.min(Math.max(parseFloat(value) / 5, 0), 1) * 100;
        return `${pct.toFixed(1)}%`;
      };
      const updateTooltip = (label, score, event) => {
        const pct = score ? formatPercent(score) : null;
        tooltip.innerHTML = `${label}: <strong>${score}${pct ? ` (${pct})` : ""}</strong>`;
        const rect = chartBox.getBoundingClientRect();
        tooltip.style.left = `${event.clientX - rect.left}px`;
        tooltip.style.top = `${event.clientY - rect.top - 10}px`;
        tooltip.style.opacity = "1";
      };
      circles.forEach(circle => {
        circle.addEventListener("mousemove", function(event){
          if(activeCircle && activeCircle !== circle) return;
          const label = circle.dataset.label || "";
          const score = circle.dataset.score || "";
          updateTooltip(label, score, event);
        });
        circle.addEventListener("click", function(event){
          activeCircle = circle;
          const label = circle.dataset.label || "";
          const score = circle.dataset.score || "";
          updateTooltip(label, score, event);
        });
        circle.addEventListener("mouseleave", function(){
          if(activeCircle && activeCircle !== circle) return;
          tooltip.style.opacity = "0";
        });
      });
      document.addEventListener("click", function(event){
        if(!chartBox.contains(event.target)){
          tooltip.style.opacity = "0";
          activeCircle = null;
        }
      });
    });
  </script>
{% endblock %}
