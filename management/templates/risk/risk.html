{% extends "layout/app_base.html" %}

{% block title %}Risk Overview{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    .risk-page{
      --rk-line:#e6eef6;
      --rk-panel:#ffffff;
      --rk-muted:#6b7280;
      --rk-accent:#0b57d0;
      --rk-shadow:0 1px 0 rgba(17,24,39,.02), 0 8px 24px rgba(17,24,39,.06);
    }
    .risk-page .panel{
      background:var(--rk-panel);
      border:1px solid var(--rk-line);
      border-radius:8px;
      box-shadow:var(--rk-shadow);
      margin-bottom:14px;
    }
    .risk-page .section-h{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      font-weight:600;
      color:#1f2937;
      padding:10px 12px 6px;
    }
    .risk-page .dot{
      width:8px;height:8px;border-radius:2px;
      background:#1d4ed8;
      box-shadow:0 0 0 2px #e7f0ff inset;
    }
    .risk-page .rating{padding:4px 12px 12px;}
    .risk-page .rating-scale{
      display:flex;
      justify-content:space-between;
      font-size:10px;
      color:#4b5563;
      margin:2px 2px 6px;
      font-weight:600;
    }
    .risk-page .rating-bar{
      height:8px;
      border-radius:999px;
      background:#e6eef6;
      position:relative;
      overflow:hidden;
    }
    .risk-page .rating-bar::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,#4caf50 0%,#8bc34a 20%,#ffc107 45%,#ff9800 70%,#f44336 100%);
      width:var(--risk-fill,0%);
      transition:width .3s ease;
    }
    .risk-page .rating-pin{
      position:absolute;
      top:50%;
      width:10px;
      height:10px;
      border-radius:50%;
      background:#fff;
      border:2px solid #0b57d0;
      transform:translate(-50%,-50%);
      box-shadow:0 0 0 3px rgba(11,87,208,.15);
    }
    .risk-page .rating-score{text-align:center;margin-top:8px;font-size:10px;font-weight:600;color:#374151;}
    .risk-page .snapshot{
      padding:0 12px 12px;
      font-size:10px;
      color:#6b7280;
      line-height:1.4;
    }
    .risk-page .grid3{
      display:grid;
      grid-template-columns:1fr 1.2fr 1fr;
      gap:12px;
      padding:10px 12px 12px;
    }
    .risk-page .risk-stack{padding:8px 10px 10px;}
    .risk-page .donut-wrap{
      display:flex;
      gap:10px;
      align-items:center;
      padding:4px 0 10px;
    }
    .risk-page .donut{width:70px;height:70px;display:block;}
    .risk-page .donut text{font-size:6px;fill:#374151;font-weight:600;}
    .risk-page .pillcol{flex:1;display:flex;flex-direction:column;gap:6px;}
    .risk-page .pill{
      height:18px;
      border-radius:2px;
      display:flex;
      align-items:center;
      padding:0 8px;
      font-size:10px;
      font-weight:600;
      border:1px solid #d9e6f3;
    }
    .risk-page .pill.blue{background:#2d7ff0;color:#fff;border-color:#2d7ff0;}
    .risk-page .pill.navy{background:#0f4ea8;color:#fff;border-color:#0f4ea8;}
    .risk-page .pill.lt{background:#cfe4f7;color:#334;}
    .risk-page .pill.wt{background:#fff;color:#334;}
    .risk-page .chartbox{padding:8px 10px 10px;}
    .risk-page .chart{
      width:100%;
      height:92px;
      border-top:1px solid #eef4fb;
      padding-top:8px;
    }
    .risk-page .axislabels{
      display:flex;
      justify-content:space-between;
      margin-top:6px;
      font-size:9px;
      color:#94a3b8;
    }
    .risk-page table{
      width:100%;
      border-collapse:collapse;
      font-size:10px;
    }
    .risk-page th,
    .risk-page td{
      padding:7px 6px;
      border-bottom:1px solid #eef4fb;
      text-align:left;
      color:#374151;
      white-space:nowrap;
    }
    .risk-page th{
      color:#64748b;
      font-weight:600;
      font-size:9px;
    }
    .risk-page td:last-child,
    .risk-page th:last-child{text-align:right;}
    .risk-page .chg.up{color:#16a34a;font-weight:600;}
    .risk-page .chg.down{color:#dc2626;font-weight:600;}
    .risk-page .risk-metrics{
      padding:10px 12px 14px;
      background:linear-gradient(#ffffff,#ffffff) padding-box,
                 linear-gradient(180deg,#ffffff,#f7fbff) border-box;
    }
    .risk-page .divider{
      height:1px;
      background:var(--rk-line);
      margin:0 0 10px 0;
    }
    .risk-page .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .risk-page .metric{
      padding:10px;
      border-radius:10px;
      background:#fff;
      border:1px solid var(--rk-line);
      box-shadow:0 1px 0 rgba(17,24,39,.02);
    }
    .risk-page .metric .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .risk-page .metric-title{
      font-size:11px;
      font-weight:600;
      color:#1f2937;
    }
    .risk-page .scale{
      display:flex;
      gap:22px;
      font-size:9px;
      color:#64748b;
      font-weight:600;
    }
    .risk-page .metric-body{
      display:grid;
      grid-template-columns:78px 1fr;
      gap:10px;
      margin-top:8px;
      align-items:start;
    }
    .risk-page .bars{display:flex;flex-direction:column;gap:9px;padding-right:6px;}
    .risk-page .barrow{
      display:grid;
      grid-template-columns:138px 1fr;
      gap:12px;
      align-items:center;
    }
    .risk-page .barrow .lbl{
      font-size:9px;
      color:#6b7280;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .risk-page .track{
      height:6px;
      background:#e9f0fb;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #dde8f7;
    }
    .risk-page .fill{
      height:100%;
      background:linear-gradient(180deg,#0b57d0,#0a4bb3);
      border-radius:999px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.25);
    }
    .risk-page .muted{color:var(--rk-muted);}
    @media (max-width:980px){
      .risk-page .grid3{grid-template-columns:1fr;}
      .risk-page .grid2{grid-template-columns:1fr;}
      .risk-page .barrow{grid-template-columns:150px 1fr;}
    }
  </style>
{% endblock %}

{% block page_content %}
  <div class="risk-page">
    <section class="panel">
      <div class="section-h"><span class="dot"></span>Current Primary Risk Rating</div>
      <div class="rating">
        <div class="rating-scale">
          <span>Low</span><span>Mild</span><span>Average</span><span>Elevated</span><span>High</span>
        </div>
        <div class="rating-bar" aria-hidden="true" style="--risk-fill: {{ risk.rating_position }}%;">
          <span class="rating-pin" style="left:var(--risk-fill,0%);"></span>
        </div>
        <div class="rating-score">{{ risk.rating_score }}</div>
      </div>
    </section>

    <section class="panel">
      <div class="section-h"><span class="dot"></span>Snapshot Summary</div>
      <div class="snapshot">
        {{ risk.snapshot }}
      </div>
    </section>

    <section class="panel">
      <div class="grid3">
        <div class="panel" style="box-shadow:none;">
          <div class="section-h" style="padding-bottom:8px;"><span class="dot"></span>Composite Risk Index</div>
          <div class="risk-stack">
          <div class="donut-wrap">
            <svg class="donut" viewBox="0 0 42 42" aria-label="Composite risk donut">
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#cfe3f0" stroke-width="4"></circle>
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#0063f7" stroke-width="4"
                      stroke-linecap="round" stroke-dasharray="{{ risk.rating_dasharray }}" transform="rotate(-90 21 21)"></circle>
              <text x="21" y="22" text-anchor="middle">{{ risk.rating_score }}/5</text>
            </svg>
            <div class="pillcol">
              {% for pill in risk.pills %}
                <div class="pill {{ pill.class }}">{{ pill.value }} {{ pill.label|lower }}</div>
              {% endfor %}
            </div>
          </div>
          </div>
        </div>

        <div class="panel" style="box-shadow:none;">
          <div class="section-h" style="padding-bottom:8px;"><span class="dot"></span>Risk Index Trend</div>
          <div class="chartbox">
            <svg class="chart" viewBox="0 0 300 110" preserveAspectRatio="none" aria-label="Risk trend chart">
              <line x1="10" y1="20" x2="290" y2="20" stroke="#eef4fb" />
              <line x1="10" y1="55" x2="290" y2="55" stroke="#eef4fb" />
              <line x1="10" y1="90" x2="290" y2="90" stroke="#eef4fb" />
              <polyline fill="none" stroke="#0b57d0" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                points="{{ risk.trend_points }}" />
              <g fill="#0b57d0">
                {% for point in risk.trend_coords %}
                  <circle cx="{{ point.x }}" cy="{{ point.y }}" r="3.2"></circle>
                {% endfor %}
              </g>
            </svg>
            <div class="axislabels">
              {% for label in risk.trend_axis %}
                <span>{{ label }}</span>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="panel" style="box-shadow:none;">
          <div class="section-h" style="padding-bottom:8px;"><span class="dot"></span>High Impact Factors</div>
          <div style="padding:0 10px 10px;">
            <table aria-label="High impact factors">
              <thead>
                <tr>
                  <th>Risk</th>
                  <th>Current Risk</th>
                  <th>Prior Risk</th>
                  <th style="text-align:right;">Change</th>
                </tr>
              </thead>
              <tbody>
                {% for factor in risk.high_impact %}
                  <tr>
                    <td>{{ factor.risk }}</td>
                    <td>{{ factor.current }}</td>
                    <td>{{ factor.prior }}</td>
                    <td class="{% if factor.direction %}chg {{ factor.direction }}{% endif %}">{{ factor.change }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="panel risk-metrics">
      <div class="section-h" style="padding:0 0 6px 0;"><span class="dot"></span>Risk Metrics</div>
      <div class="divider"></div>

      <div class="grid2">
        {% for metric in risk.metrics %}
          <div class="metric">
            <div class="top">
              <div class="metric-title">{{ metric.label }}</div>
              <div class="scale"><span>Low</span><span>Mild</span><span>Moderate</span><span>Elevated</span><span>High</span></div>
            </div>
            <div class="metric-body">
              <svg class="donut" viewBox="0 0 42 42" aria-label="{{ metric.label }} score donut">
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="{{ metric.donut_bg }}" stroke-width="4"></circle>
              <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="{{ metric.donut_color }}" stroke-width="4"
                      stroke-linecap="round" stroke-dasharray="{{ metric.donut_dash }}" transform="rotate(-90 21 21)"></circle>
              <text x="21" y="22" text-anchor="middle">{{ metric.score_display }}</text>
            </svg>
            <div class="bars">
              {% for bar in metric.bars %}
                <div class="barrow">
                  <div class="lbl">{{ bar.label }}</div>
                  <div class="track">
                    <div class="fill" style="width:{{ bar.width }}; background:{{ metric.fill_color }}"></div>
                  </div>
                </div>
              {% endfor %}
            </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
{% endblock %}
